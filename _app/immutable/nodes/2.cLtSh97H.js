var he=Object.defineProperty;var le=(l,o,f)=>o in l?he(l,o,{enumerable:!0,configurable:!0,writable:!0,value:f}):l[o]=f;var U=(l,o,f)=>le(l,typeof o!="symbol"?o+"":o,f);import{t as lt,a as at}from"../chunks/DO3V2P7S.js";import{i as jt}from"../chunks/TuYPhmGD.js";import{F as de,i as fe,K as wt,m as q,L as ce,O as ue,g as k,af as pe,a6 as _e,a7 as Pt,J as St,o as ot,P as ge,a8 as Xt,j as Kt,a9 as me,ar as xt,T as Zt,D as Lt,as as ye,al as ve,$ as Rt,B as be,at as we,au as Se,S as xe,av as Ue,k as Ee,aw as Te,ax as Ae,I as ze,ay as Be,a5 as Fe,az as Ie,a3 as Ce,aA as ke,q as Jt,aB as _t,aC as Tt,aD as Qt,s as $t,a2 as it,e as M,aE as Pe,t as Dt,aF as Le,v as et,w as Q,x as Ut}from"../chunks/DszmiMlM.js";import{a as Re,s as Nt}from"../chunks/CORh8HuV.js";import{p as O,b as De,i as Ne}from"../chunks/BfQjfqf4.js";import{o as te,a as ee}from"../chunks/eQJXu9Ok.js";import{b as Me}from"../chunks/CQBY5R-f.js";function Oe(l,o){return o}function He(l,o,f,a){for(var _=[],g=o.length,v=0;v<g;v++)Se(o[v].e,_,!0);var r=g>0&&_.length===0&&f!==null;if(r){var S=f.parentNode;xe(S),S.append(f),a.clear(),J(l,o[0].prev,o[g-1].next)}Ue(_,()=>{for(var w=0;w<g;w++){var u=o[w];r||(a.delete(u.k),J(l,u.prev,u.next)),Ee(u.e,!r)}})}function Ge(l,o,f,a,_,g=null){var v=l,r={flags:o,items:new Map,first:null};{var S=l;v=q?wt(ce(S)):S.appendChild(de())}q&&ue();var w=null,u=!1,E=pe(()=>{var t=f();return be(t)?t:t==null?[]:Zt(t)});fe(()=>{var t=k(E),e=t.length;if(u&&e===0)return;u=e===0;let i=!1;if(q){var s=v.data===_e;s!==(e===0)&&(v=Pt(),wt(v),St(!1),i=!0)}if(q){for(var n=null,h,d=0;d<e;d++){if(ot.nodeType===8&&ot.data===ge){v=ot,i=!0,St(!1);break}var c=t[d],p=a(c,d);h=ie(ot,r,n,null,c,p,d,_,o,f),r.items.set(p,h),n=h}e>0&&wt(Pt())}q||Ve(t,r,v,_,o,a,f),g!==null&&(e===0?w?Xt(w):w=Kt(()=>g(v)):w!==null&&me(w,()=>{w=null})),i&&St(!0),k(E)}),q&&(v=ot)}function Ve(l,o,f,a,_,g,v){var r=l.length,S=o.items,w=o.first,u=w,E,t=null,e=[],i=[],s,n,h,d;for(d=0;d<r;d+=1){if(s=l[d],n=g(s,d),h=S.get(n),h===void 0){var c=u?u.e.nodes_start:f;t=ie(c,o,t,t===null?o.first:t.next,s,n,d,a,_,v),S.set(n,t),e=[],i=[],u=t.next;continue}if(Ye(h,s,d),(h.e.f&xt)!==0&&Xt(h.e),h!==u){if(E!==void 0&&E.has(h)){if(e.length<i.length){var p=i[0],m;t=p.prev;var y=e[0],x=e[e.length-1];for(m=0;m<e.length;m+=1)Mt(e[m],p,f);for(m=0;m<i.length;m+=1)E.delete(i[m]);J(o,y.prev,x.next),J(o,t,y),J(o,x,p),u=p,t=x,d-=1,e=[],i=[]}else E.delete(h),Mt(h,u,f),J(o,h.prev,h.next),J(o,h,t===null?o.first:t.next),J(o,t,h),t=h;continue}for(e=[],i=[];u!==null&&u.k!==n;)(u.e.f&xt)===0&&(E??(E=new Set)).add(u),i.push(u),u=u.next;if(u===null)continue;h=u}e.push(h),t=h,u=h.next}if(u!==null||E!==void 0){for(var A=E===void 0?[]:Zt(E);u!==null;)(u.e.f&xt)===0&&A.push(u),u=u.next;var b=A.length;if(b>0){var P=r===0?f:null;He(o,A,P,S)}}Lt.first=o.first&&o.first.e,Lt.last=t&&t.e}function Ye(l,o,f,a){ye(l.v,o),l.i=f}function ie(l,o,f,a,_,g,v,r,S,w){var u=(S&Te)!==0,E=(S&Ae)===0,t=u?E?ve(_):Rt(_):_,e=(S&we)===0?v:Rt(v),i={i:e,v:t,k:g,a:null,e:null,prev:f,next:a};try{return i.e=Kt(()=>r(l,t,e,w),q),i.e.prev=f&&f.e,i.e.next=a&&a.e,f===null?o.first=i:(f.next=i,f.e.next=i.e),a!==null&&(a.prev=i,a.e.prev=i.e),i}finally{}}function Mt(l,o,f){for(var a=l.next?l.next.e.nodes_start:f,_=o?o.e.nodes_start:f,g=l.e.nodes_start;g!==a;){var v=ze(g);_.before(g),g=v}}function J(l,o,f){o===null?l.first=f:(o.next=f,o.e.next=f&&f.e),f!==null&&(f.prev=o,f.e.prev=o&&o.e)}function We(l,o){return l==null?null:String(l)}function qe(l,o,f,a){var _=l.__style;if(q||_!==o){var g=We(o);(!q||g!==l.getAttribute("style"))&&(g==null?l.removeAttribute("style"):l.style.cssText=g),l.__style=o}return a}const je=Symbol("is custom element"),Xe=Symbol("is html");function Ke(l,o,f,a){var _=Ze(l);q&&(_[o]=l.getAttribute(o)),_[o]!==(_[o]=f)&&(f==null?l.removeAttribute(o):typeof f!="string"&&Je(l).includes(o)?l[o]=f:l.setAttribute(o,f))}function Ze(l){return l.__attributes??(l.__attributes={[je]:l.nodeName.includes("-"),[Xe]:l.namespaceURI===Be})}var Ot=new Map;function Je(l){var o=Ot.get(l.nodeName);if(o)return o;Ot.set(l.nodeName,o=[]);for(var f,a=l,_=Element.prototype;_!==a;){f=Ie(a);for(var g in f)f[g].set&&o.push(g);a=Fe(a)}return o}function Qe(l,o,f){var a=Ce(l,o);a&&a.set&&(l[o]=f,ke(()=>{l[o]=null}))}function $e(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var ht={exports:{}},ti=ht.exports,Ht;function ei(){return Ht||(Ht=1,function(l,o){(function(f,a){var _="1.0.33",g="",v="?",r="function",S="undefined",w="object",u="string",E="major",t="model",e="name",i="type",s="vendor",n="version",h="architecture",d="console",c="mobile",p="tablet",m="smarttv",y="wearable",x="embedded",A=350,b="Amazon",P="Apple",L="ASUS",j="BlackBerry",H="Browser",G="Chrome",D="Edge",N="Firefox",X="Google",$="Huawei",V="LG",K="Microsoft",T="Motorola",dt="Opera",gt="Samsung",At="Sharp",ft="Sony",mt="Xiaomi",yt="Zebra",zt="Facebook",ne=function(z,I){var B={};for(var R in z)I[R]&&I[R].length%2===0?B[R]=I[R].concat(z[R]):B[R]=z[R];return B},ct=function(z){for(var I={},B=0;B<z.length;B++)I[z[B].toUpperCase()]=z[B];return I},Bt=function(z,I){return typeof z===u?st(I).indexOf(st(z))!==-1:!1},st=function(z){return z.toLowerCase()},oe=function(z){return typeof z===u?z.replace(/[^\d\.]/g,g).split(".")[0]:a},vt=function(z,I){if(typeof z===u)return z=z.replace(/^\s\s*/,g),typeof I===S?z:z.substring(0,A)},rt=function(z,I){for(var B=0,R,F,pt,C,nt,W;B<I.length&&!nt;){var Ct=I[B],kt=I[B+1];for(R=F=0;R<Ct.length&&!nt;)if(nt=Ct[R++].exec(z),nt)for(pt=0;pt<kt.length;pt++)W=nt[++F],C=kt[pt],typeof C===w&&C.length>0?C.length===2?typeof C[1]==r?this[C[0]]=C[1].call(this,W):this[C[0]]=C[1]:C.length===3?typeof C[1]===r&&!(C[1].exec&&C[1].test)?this[C[0]]=W?C[1].call(this,W,C[2]):a:this[C[0]]=W?W.replace(C[1],C[2]):a:C.length===4&&(this[C[0]]=W?C[3].call(this,W.replace(C[1],C[2])):a):this[C]=W||a;B+=2}},bt=function(z,I){for(var B in I)if(typeof I[B]===w&&I[B].length>0){for(var R=0;R<I[B].length;R++)if(Bt(I[B][R],z))return B===v?a:B}else if(Bt(I[B],z))return B===v?a:B;return z},ae={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},Ft={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},It={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[n,[e,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[n,[e,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[e,n],[/opios[\/ ]+([\w\.]+)/i],[n,[e,dt+" Mini"]],[/\bopr\/([\w\.]+)/i],[n,[e,dt]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[e,n],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[n,[e,"UC"+H]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[n,[e,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[n,[e,"WeChat"]],[/konqueror\/([\w\.]+)/i],[n,[e,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[n,[e,"IE"]],[/yabrowser\/([\w\.]+)/i],[n,[e,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[e,/(.+)/,"$1 Secure "+H],n],[/\bfocus\/([\w\.]+)/i],[n,[e,N+" Focus"]],[/\bopt\/([\w\.]+)/i],[n,[e,dt+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[n,[e,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[n,[e,"Dolphin"]],[/coast\/([\w\.]+)/i],[n,[e,dt+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[n,[e,"MIUI "+H]],[/fxios\/([-\w\.]+)/i],[n,[e,N]],[/\bqihu|(qi?ho?o?|360)browser/i],[[e,"360 "+H]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[e,/(.+)/,"$1 "+H],n],[/(comodo_dragon)\/([\w\.]+)/i],[[e,/_/g," "],n],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[e,n],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[e],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[e,zt],n],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[e,n],[/\bgsa\/([\w\.]+) .*safari\//i],[n,[e,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[n,[e,G+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[e,G+" WebView"],n],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[n,[e,"Android "+H]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[e,n],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[n,[e,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[n,e],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[e,[n,bt,ae]],[/(webkit|khtml)\/([\w\.]+)/i],[e,n],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[e,"Netscape"],n],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[n,[e,N+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[e,n],[/(cobalt)\/([\w\.]+)/i],[e,[n,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[h,"amd64"]],[/(ia32(?=;))/i],[[h,st]],[/((?:i[346]|x)86)[;\)]/i],[[h,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[h,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[h,"armhf"]],[/windows (ce|mobile); ppc;/i],[[h,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[h,/ower/,g,st]],[/(sun4\w)[;\)]/i],[[h,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[h,st]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[t,[s,gt],[i,p]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[t,[s,gt],[i,c]],[/\((ip(?:hone|od)[\w ]*);/i],[t,[s,P],[i,c]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[t,[s,P],[i,p]],[/(macintosh);/i],[t,[s,P]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[t,[s,$],[i,p]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[t,[s,$],[i,c]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[t,/_/g," "],[s,mt],[i,c]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[t,/_/g," "],[s,mt],[i,p]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[t,[s,"OPPO"],[i,c]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[t,[s,"Vivo"],[i,c]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[t,[s,"Realme"],[i,c]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[t,[s,T],[i,c]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[t,[s,T],[i,p]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[t,[s,V],[i,p]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[t,[s,V],[i,c]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[t,[s,"Lenovo"],[i,p]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[t,/_/g," "],[s,"Nokia"],[i,c]],[/(pixel c)\b/i],[t,[s,X],[i,p]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[t,[s,X],[i,c]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[t,[s,ft],[i,c]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[t,"Xperia Tablet"],[s,ft],[i,p]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[t,[s,"OnePlus"],[i,c]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[t,[s,b],[i,p]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[t,/(.+)/g,"Fire Phone $1"],[s,b],[i,c]],[/(playbook);[-\w\),; ]+(rim)/i],[t,s,[i,p]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[t,[s,j],[i,c]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[t,[s,L],[i,p]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[t,[s,L],[i,c]],[/(nexus 9)/i],[t,[s,"HTC"],[i,p]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony(?!-bra))[-_ ]?([-\w]*)/i],[s,[t,/_/g," "],[i,c]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[t,[s,"Acer"],[i,p]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[t,[s,"Meizu"],[i,c]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[t,[s,At],[i,c]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[s,t,[i,c]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[s,t,[i,p]],[/(surface duo)/i],[t,[s,K],[i,p]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[t,[s,"Fairphone"],[i,c]],[/(u304aa)/i],[t,[s,"AT&T"],[i,c]],[/\bsie-(\w*)/i],[t,[s,"Siemens"],[i,c]],[/\b(rct\w+) b/i],[t,[s,"RCA"],[i,p]],[/\b(venue[\d ]{2,7}) b/i],[t,[s,"Dell"],[i,p]],[/\b(q(?:mv|ta)\w+) b/i],[t,[s,"Verizon"],[i,p]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[t,[s,"Barnes & Noble"],[i,p]],[/\b(tm\d{3}\w+) b/i],[t,[s,"NuVision"],[i,p]],[/\b(k88) b/i],[t,[s,"ZTE"],[i,p]],[/\b(nx\d{3}j) b/i],[t,[s,"ZTE"],[i,c]],[/\b(gen\d{3}) b.+49h/i],[t,[s,"Swiss"],[i,c]],[/\b(zur\d{3}) b/i],[t,[s,"Swiss"],[i,p]],[/\b((zeki)?tb.*\b) b/i],[t,[s,"Zeki"],[i,p]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[s,"Dragon Touch"],t,[i,p]],[/\b(ns-?\w{0,9}) b/i],[t,[s,"Insignia"],[i,p]],[/\b((nxa|next)-?\w{0,9}) b/i],[t,[s,"NextBook"],[i,p]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[s,"Voice"],t,[i,c]],[/\b(lvtel\-)?(v1[12]) b/i],[[s,"LvTel"],t,[i,c]],[/\b(ph-1) /i],[t,[s,"Essential"],[i,c]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[t,[s,"Envizen"],[i,p]],[/\b(trio[-\w\. ]+) b/i],[t,[s,"MachSpeed"],[i,p]],[/\btu_(1491) b/i],[t,[s,"Rotor"],[i,p]],[/(shield[\w ]+) b/i],[t,[s,"Nvidia"],[i,p]],[/(sprint) (\w+)/i],[s,t,[i,c]],[/(kin\.[onetw]{3})/i],[[t,/\./g," "],[s,K],[i,c]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[t,[s,yt],[i,p]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[t,[s,yt],[i,c]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[s,t,[i,d]],[/droid.+; (shield) bui/i],[t,[s,"Nvidia"],[i,d]],[/(playstation [345portablevi]+)/i],[t,[s,ft],[i,d]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[t,[s,K],[i,d]],[/smart-tv.+(samsung)/i],[s,[i,m]],[/hbbtv.+maple;(\d+)/i],[[t,/^/,"SmartTV"],[s,gt],[i,m]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[s,V],[i,m]],[/(apple) ?tv/i],[s,[t,P+" TV"],[i,m]],[/crkey/i],[[t,G+"cast"],[s,X],[i,m]],[/droid.+aft(\w)( bui|\))/i],[t,[s,b],[i,m]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[t,[s,At],[i,m]],[/(bravia[\w ]+)( bui|\))/i],[t,[s,ft],[i,m]],[/(mitv-\w{5}) bui/i],[t,[s,mt],[i,m]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[s,vt],[t,vt],[i,m]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[i,m]],[/((pebble))app/i],[s,t,[i,y]],[/droid.+; (glass) \d/i],[t,[s,X],[i,y]],[/droid.+; (wt63?0{2,3})\)/i],[t,[s,yt],[i,y]],[/(quest( 2)?)/i],[t,[s,zt],[i,y]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[s,[i,x]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[t,[i,c]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[t,[i,p]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[i,p]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[i,c]],[/(android[-\w\. ]{0,9});.+buil/i],[t,[s,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[n,[e,D+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[n,[e,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[e,n],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[n,e]],os:[[/microsoft (windows) (vista|xp)/i],[e,n],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[e,[n,bt,Ft]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[e,"Windows"],[n,bt,Ft]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[n,/_/g,"."],[e,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[e,"Mac OS"],[n,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[n,e],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[e,n],[/\(bb(10);/i],[n,[e,j]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[n,[e,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[n,[e,N+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[n,[e,"webOS"]],[/crkey\/([\d\.]+)/i],[n,[e,G+"cast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[e,"Chromium OS"],n],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[e,n],[/(sunos) ?([\w\.\d]*)/i],[[e,"Solaris"],n],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[e,n]]},Y=function(z,I){if(typeof z===w&&(I=z,z=a),!(this instanceof Y))return new Y(z,I).getResult();var B=z||(typeof f!==S&&f.navigator&&f.navigator.userAgent?f.navigator.userAgent:g),R=I?ne(It,I):It;return this.getBrowser=function(){var F={};return F[e]=a,F[n]=a,rt.call(F,B,R.browser),F.major=oe(F.version),F},this.getCPU=function(){var F={};return F[h]=a,rt.call(F,B,R.cpu),F},this.getDevice=function(){var F={};return F[s]=a,F[t]=a,F[i]=a,rt.call(F,B,R.device),F},this.getEngine=function(){var F={};return F[e]=a,F[n]=a,rt.call(F,B,R.engine),F},this.getOS=function(){var F={};return F[e]=a,F[n]=a,rt.call(F,B,R.os),F},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return B},this.setUA=function(F){return B=typeof F===u&&F.length>A?vt(F,A):F,this},this.setUA(B),this};Y.VERSION=_,Y.BROWSER=ct([e,n,E]),Y.CPU=ct([h]),Y.DEVICE=ct([t,s,i,d,c,m,p,y,x]),Y.ENGINE=Y.OS=ct([e,n]),l.exports&&(o=l.exports=Y),o.UAParser=Y;var tt=typeof f!==S&&(f.jQuery||f.Zepto);if(tt&&!tt.ua){var ut=new Y;tt.ua=ut.getResult(),tt.ua.get=function(){return ut.getUA()},tt.ua.set=function(z){ut.setUA(z);var I=ut.getResult();for(var B in I)tt.ua[B]=I[B]}}})(typeof window=="object"?window:ti)}(ht,ht.exports)),ht.exports}var ii=ei();const si=$e(ii);var Et={},Gt;function ri(){return Gt||(Gt=1,function(l){var o=function(){var t=new Date,e=4,i=3,s=2,n=1,h=e,d={setLogLevel:function(c){c==this.debug?h=n:c==this.info?h=s:c==this.warn?h=i:(c==this.error,h=e)},debug:function(c,p){console.debug===void 0&&(console.debug=console.log),n>=h&&console.debug("["+o.getDurationString(new Date-t,1e3)+"]","["+c+"]",p)},log:function(c,p){this.debug(c.msg)},info:function(c,p){s>=h&&console.info("["+o.getDurationString(new Date-t,1e3)+"]","["+c+"]",p)},warn:function(c,p){i>=h&&console.warn("["+o.getDurationString(new Date-t,1e3)+"]","["+c+"]",p)},error:function(c,p){e>=h&&console.error("["+o.getDurationString(new Date-t,1e3)+"]","["+c+"]",p)}};return d}();o.getDurationString=function(t,e){var i;function s(m,y){for(var x=""+m,A=x.split(".");A[0].length<y;)A[0]="0"+A[0];return A.join(".")}t<0?(i=!0,t=-t):i=!1;var n=e||1,h=t/n,d=Math.floor(h/3600);h-=d*3600;var c=Math.floor(h/60);h-=c*60;var p=h*1e3;return h=Math.floor(h),p-=h*1e3,p=Math.floor(p),(i?"-":"")+d+":"+s(c,2)+":"+s(h,2)+"."+s(p,3)},o.printRanges=function(t){var e=t.length;if(e>0){for(var i="",s=0;s<e;s++)s>0&&(i+=","),i+="["+o.getDurationString(t.start(s))+","+o.getDurationString(t.end(s))+"]";return i}else return"(empty)"},l.Log=o;var f=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};f.prototype.getPosition=function(){return this.position},f.prototype.getEndPosition=function(){return this.buffer.byteLength},f.prototype.getLength=function(){return this.buffer.byteLength},f.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},f.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},f.prototype.readAnyInt=function(t,e){var i=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?i=this.dataview.getInt8(this.position):i=this.dataview.getUint8(this.position);break;case 2:e?i=this.dataview.getInt16(this.position):i=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";i=this.dataview.getUint8(this.position)<<16,i|=this.dataview.getUint8(this.position+1)<<8,i|=this.dataview.getUint8(this.position+2);break;case 4:e?i=this.dataview.getInt32(this.position):i=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";i=this.dataview.getUint32(this.position)<<32,i|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,i}else throw"Not enough bytes in buffer"},f.prototype.readUint8=function(){return this.readAnyInt(1,!1)},f.prototype.readUint16=function(){return this.readAnyInt(2,!1)},f.prototype.readUint24=function(){return this.readAnyInt(3,!1)},f.prototype.readUint32=function(){return this.readAnyInt(4,!1)},f.prototype.readUint64=function(){return this.readAnyInt(8,!1)},f.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",i=0;i<t;i++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},f.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},f.prototype.readInt8=function(){return this.readAnyInt(1,!0)},f.prototype.readInt16=function(){return this.readAnyInt(2,!0)},f.prototype.readInt32=function(){return this.readAnyInt(4,!0)},f.prototype.readInt64=function(){return this.readAnyInt(8,!1)},f.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),i=0;i<t;i++)e[i]=this.readUint8();return e},f.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readInt16();return e},f.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readUint16();return e},f.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),i=0;i<t;i++)e[i]=this.readUint32();return e},f.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),i=0;i<t;i++)e[i]=this.readInt32();return e},l.MP4BoxStream=f;var a=function(t,e,i){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=i??a.LITTLE_ENDIAN};a.prototype={},a.prototype.getPosition=function(){return this.position},a.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i){e>this._byteLength&&(this._byteLength=e);return}for(i<1&&(i=1);e>i;)i*=2;var s=new ArrayBuffer(i),n=new Uint8Array(this._buffer),h=new Uint8Array(s,0,n.length);h.set(n),this.buffer=s,this._byteLength=e}},a.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}},a.BIG_ENDIAN=!1,a.LITTLE_ENDIAN=!0,a.prototype._byteLength=0,Object.defineProperty(a.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(a.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(a.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(a.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),a.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},a.prototype.isEof=function(){return this.position>=this._byteLength},a.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},a.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var i=new Int32Array(t);return a.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),a.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},a.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var i=new Int16Array(t);return a.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),a.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},a.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return a.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},a.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var i=new Uint32Array(t);return a.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),a.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},a.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var i=new Uint16Array(t);return a.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),a.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},a.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return a.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},a.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var i=new Float64Array(t);return a.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),a.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},a.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var i=new Float32Array(t);return a.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),a.arrayToNative(i,e??this.endianness),this.position+=i.byteLength,i},a.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},a.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},a.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},a.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},a.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},a.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},a.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},a.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},a.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,a.memcpy=function(t,e,i,s,n){var h=new Uint8Array(t,e,n),d=new Uint8Array(i,s,n);h.set(d)},a.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},a.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},a.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(var s=i+t.BYTES_PER_ELEMENT-1,n=i;s>n;s--,n++){var h=e[n];e[n]=e[s],e[s]=h}return t},a.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return String.fromCharCode.apply(null,e)},a.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},a.prototype.readCString=function(t){var e=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),s=e;t!=null&&(s=Math.min(t,e));for(var n=0;n<s&&i[n]!==0;n++);var h=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(n)]);return t!=null?this.position+=s-n:n!=e&&(this.position+=1),h};var _=Math.pow(2,32);a.prototype.readInt64=function(){return this.readInt32()*_+this.readUint32()},a.prototype.readUint64=function(){return this.readUint32()*_+this.readUint32()},a.prototype.readInt64=function(){return this.readUint32()*_+this.readUint32()},a.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},l.DataStream=a,a.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.setAttribute("href",i),s.setAttribute("download",t),s.setAttribute("target","_self"),s.click(),window.URL.revokeObjectURL(i)}else throw"DataStream.save: Can't create object URL."},a.prototype._dynamicSize=!0,Object.defineProperty(a.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),a.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),i=new Uint8Array(e),s=new Uint8Array(this._buffer,t,i.length);i.set(s),this.buffer=e,this.position-=t},a.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)a.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt32(t[i],e)},a.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)a.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt16(t[i],e)},a.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)a.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},a.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)a.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint32(t[i],e)},a.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)a.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint16(t[i],e)},a.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)a.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},a.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)a.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat64(t[i],e)},a.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)a.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat32(t[i],e)},a.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},a.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},a.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},a.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},a.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},a.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},a.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},a.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},a.prototype.writeUCS2String=function(t,e,i){i==null&&(i=t.length);for(var s=0;s<t.length&&s<i;s++)this.writeUint16(t.charCodeAt(s),e);for(;s<i;s++)this.writeUint16(0)},a.prototype.writeString=function(t,e,i){var s=0;if(e==null||e=="ASCII")if(i!=null){var n=Math.min(t.length,i);for(s=0;s<n;s++)this.writeUint8(t.charCodeAt(s));for(;s<i;s++)this.writeUint8(0)}else for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))},a.prototype.writeCString=function(t,e){var i=0;if(e!=null){var s=Math.min(t.length,e);for(i=0;i<s;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}},a.prototype.writeStruct=function(t,e){for(var i=0;i<t.length;i+=2){var s=t[i+1];this.writeType(s,e[t[i]],e)}},a.prototype.writeType=function(t,e,i){var s;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,i);var n=null,h="ASCII",d=this.position;switch(typeof t=="string"&&/:/.test(t)&&(s=t.split(":"),t=s[0],n=parseInt(s[1])),typeof t=="string"&&/,/.test(t)&&(s=t.split(","),t=s[0],h=parseInt(s[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,a.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,a.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,a.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,a.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,a.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,a.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,a.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,a.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,a.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,a.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,a.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,a.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,n);break;case"string":this.writeString(e,h,n);break;case"u16string":this.writeUCS2String(e,this.endianness,n);break;case"u16stringle":this.writeUCS2String(e,a.LITTLE_ENDIAN,n);break;case"u16stringbe":this.writeUCS2String(e,a.BIG_ENDIAN,n);break;default:if(t.length==3){for(var c=t[1],p=0;p<e.length;p++)this.writeType(c,e[p]);break}else{this.writeStruct(t,e);break}}n!=null&&(this.position=d,this._realloc(n),this.position=d+n)},a.prototype.writeUint64=function(t){var e=Math.floor(t/_);this.writeUint32(e),this.writeUint32(t&4294967295)},a.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},a.prototype.adjustUint32=function(t,e){var i=this.position;this.seek(t),this.writeUint32(e),this.seek(i)},a.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return a.arrayToNative(i,e??this.endianness),this.position+=t*4,i},a.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return a.arrayToNative(i,e??this.endianness),this.position+=t*2,i},a.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},a.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return a.arrayToNative(i,e??this.endianness),this.position+=t*4,i},a.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return a.arrayToNative(i,e??this.endianness),this.position+=t*2,i},a.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return a.arrayToNative(i,e??this.endianness),this.position+=t*8,i},a.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return a.arrayToNative(i,e??this.endianness),this.position+=t*4,i};var g=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};g.prototype=new a(new ArrayBuffer,0,a.BIG_ENDIAN),g.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,o.debug("MultiBufferStream","Stream ready for parsing"),!0):(o.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(o.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){o.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i.buffer},g.prototype.reduceBuffer=function(t,e,i){var s;return s=new Uint8Array(i),s.set(new Uint8Array(t,e,i)),s.buffer.fileStart=t.fileStart+e,s.buffer.usedBytes=0,s.buffer},g.prototype.insertBuffer=function(t){for(var e=!0,i=0;i<this.buffers.length;i++){var s=this.buffers[i];if(t.fileStart<=s.fileStart){if(t.fileStart===s.fileStart)if(t.byteLength>s.byteLength){this.buffers.splice(i,1),i--;continue}else o.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=s.fileStart||(t=this.reduceBuffer(t,0,s.fileStart-t.fileStart)),o.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(i,0,t),i===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<s.fileStart+s.byteLength){var n=s.fileStart+s.byteLength-t.fileStart,h=t.byteLength-n;if(h>0)t=this.reduceBuffer(t,n,h);else{e=!1;break}}}e&&(o.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),i===0&&(this.buffer=t))},g.prototype.logBufferLevel=function(t){var e,i,s,n,h=[],d,c="";for(s=0,n=0,e=0;e<this.buffers.length;e++)i=this.buffers[e],e===0?(d={},h.push(d),d.start=i.fileStart,d.end=i.fileStart+i.byteLength,c+="["+d.start+"-"):d.end===i.fileStart?d.end=i.fileStart+i.byteLength:(d={},d.start=i.fileStart,c+=h[h.length-1].end-1+"], ["+d.start+"-",d.end=i.fileStart+i.byteLength,h.push(d)),s+=i.usedBytes,n+=i.byteLength;h.length>0&&(c+=d.end-1+"]");var p=t?o.info:o.debug;this.buffers.length===0?p("MultiBufferStream","No more buffer in memory"):p("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+s+"/"+n+" bytes), continuous ranges: "+c)},g.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(o.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},g.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,i=this.buffer.usedBytes,s=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=i,this.buffer.fileStart=s,o.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},g.prototype.findPosition=function(t,e,i){var s,n=null,h=-1;for(t===!0?s=0:s=this.bufferIndex;s<this.buffers.length&&(n=this.buffers[s],n.fileStart<=e);){h=s,i&&(n.fileStart+n.byteLength<=e?n.usedBytes=n.byteLength:n.usedBytes=e-n.fileStart,this.logBufferLevel());s++}return h!==-1?(n=this.buffers[h],n.fileStart+n.byteLength>=e?(o.debug("MultiBufferStream","Found position in existing buffer #"+h),h):-1):-1},g.prototype.findEndContiguousBuf=function(t){var e,i,s,n=t!==void 0?t:this.bufferIndex;if(i=this.buffers[n],this.buffers.length>n+1)for(e=n+1;e<this.buffers.length&&(s=this.buffers[e],s.fileStart===i.fileStart+i.byteLength);e++)i=s;return i.fileStart+i.byteLength},g.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},g.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},g.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},g.prototype.seek=function(t,e,i){var s;return s=this.findPosition(e,t,i),s!==-1?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=t-this.buffer.fileStart,o.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(o.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},g.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},g.prototype.getLength=function(){return this.byteLength},g.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},l.MultiBufferStream=g;var v=function(){var t=3,e=4,i=5,s=6,n=[];n[t]="ES_Descriptor",n[e]="DecoderConfigDescriptor",n[i]="DecoderSpecificInfo",n[s]="SLConfigDescriptor",this.getDescriptorName=function(c){return n[c]};var h=this,d={};return this.parseOneDescriptor=function(c){var p=0,m,y,x;for(m=c.readUint8(),x=c.readUint8();x&128;)p=(x&127)<<7,x=c.readUint8();return p+=x&127,o.debug("MPEG4DescriptorParser","Found "+(n[m]||"Descriptor "+m)+", size "+p+" at position "+c.getPosition()),n[m]?y=new d[n[m]](p):y=new d.Descriptor(p),y.parse(c),y},d.Descriptor=function(c,p){this.tag=c,this.size=p,this.descs=[]},d.Descriptor.prototype.parse=function(c){this.data=c.readUint8Array(this.size)},d.Descriptor.prototype.findDescriptor=function(c){for(var p=0;p<this.descs.length;p++)if(this.descs[p].tag==c)return this.descs[p];return null},d.Descriptor.prototype.parseRemainingDescriptors=function(c){for(var p=c.position;c.position<p+this.size;){var m=h.parseOneDescriptor(c);this.descs.push(m)}},d.ES_Descriptor=function(c){d.Descriptor.call(this,t,c)},d.ES_Descriptor.prototype=new d.Descriptor,d.ES_Descriptor.prototype.parse=function(c){if(this.ES_ID=c.readUint16(),this.flags=c.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=c.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var p=c.readUint8();this.URL=c.readString(p),this.size-=p+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=c.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(c)},d.ES_Descriptor.prototype.getOTI=function(c){var p=this.findDescriptor(e);return p?p.oti:0},d.ES_Descriptor.prototype.getAudioConfig=function(c){var p=this.findDescriptor(e);if(!p)return null;var m=p.findDescriptor(i);if(m&&m.data){var y=(m.data[0]&248)>>3;return y===31&&m.data.length>=2&&(y=32+((m.data[0]&7)<<3)+((m.data[1]&224)>>5)),y}else return null},d.DecoderConfigDescriptor=function(c){d.Descriptor.call(this,e,c)},d.DecoderConfigDescriptor.prototype=new d.Descriptor,d.DecoderConfigDescriptor.prototype.parse=function(c){this.oti=c.readUint8(),this.streamType=c.readUint8(),this.bufferSize=c.readUint24(),this.maxBitrate=c.readUint32(),this.avgBitrate=c.readUint32(),this.size-=13,this.parseRemainingDescriptors(c)},d.DecoderSpecificInfo=function(c){d.Descriptor.call(this,i,c)},d.DecoderSpecificInfo.prototype=new d.Descriptor,d.SLConfigDescriptor=function(c){d.Descriptor.call(this,s,c)},d.SLConfigDescriptor.prototype=new d.Descriptor,this};l.MPEG4DescriptorParser=v;var r={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){r.FullBox.prototype=new r.Box,r.ContainerBox.prototype=new r.Box,r.SampleEntry.prototype=new r.Box,r.TrackGroupTypeBox.prototype=new r.FullBox,r.BASIC_BOXES.forEach(function(t){r.createBoxCtor(t)}),r.FULL_BOXES.forEach(function(t){r.createFullBoxCtor(t)}),r.CONTAINER_BOXES.forEach(function(t){r.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,i){this.type=t,this.size=e,this.uuid=i},FullBox:function(t,e,i){r.Box.call(this,t,e,i),this.flags=0,this.version=0},ContainerBox:function(t,e,i){r.Box.call(this,t,e,i),this.boxes=[]},SampleEntry:function(t,e,i,s){r.ContainerBox.call(this,t,e),this.hdr_size=i,this.start=s},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){r.FullBox.call(this,t,e)},createBoxCtor:function(t,e){r.boxCodes.push(t),r[t+"Box"]=function(i){r.Box.call(this,t,i)},r[t+"Box"].prototype=new r.Box,e&&(r[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){r[t+"Box"]=function(i){r.FullBox.call(this,t,i)},r[t+"Box"].prototype=new r.FullBox,r[t+"Box"].prototype.parse=function(i){this.parseFullHeader(i),e&&e.call(this,i)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,i=0;i<e;i++)this[t[i]+"s"]=[]}},createContainerBoxCtor:function(t,e,i){r[t+"Box"]=function(s){r.ContainerBox.call(this,t,s),r.addSubBoxArrays.call(this,i)},r[t+"Box"].prototype=new r.ContainerBox,e&&(r[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,i){r.sampleEntryCodes[t]=[],r[t+"SampleEntry"]=function(s,n){r.SampleEntry.call(this,s,n),r.addSubBoxArrays.call(this,i)},r[t+"SampleEntry"].prototype=new r.SampleEntry,e&&(r[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,i,s){r.sampleEntryCodes[t].push(e),r[e+"SampleEntry"]=function(n){r[t+"SampleEntry"].call(this,e,n),r.addSubBoxArrays.call(this,s)},r[e+"SampleEntry"].prototype=new r[t+"SampleEntry"],i&&(r[e+"SampleEntry"].prototype.parse=i)},createEncryptedSampleEntryCtor:function(t,e,i){r.createSampleEntryCtor.call(this,t,e,i,["sinf"])},createSampleGroupCtor:function(t,e){r[t+"SampleGroupEntry"]=function(i){r.SampleGroupEntry.call(this,t,i)},r[t+"SampleGroupEntry"].prototype=new r.SampleGroupEntry,e&&(r[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){r[t+"TrackGroupTypeBox"]=function(i){r.TrackGroupTypeBox.call(this,t,i)},r[t+"TrackGroupTypeBox"].prototype=new r.TrackGroupTypeBox,e&&(r[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,i,s){r.UUIDs.push(t),r.UUIDBoxes[t]=function(n){e?r.FullBox.call(this,"uuid",n,t):i?r.ContainerBox.call(this,"uuid",n,t):r.Box.call(this,"uuid",n,t)},r.UUIDBoxes[t].prototype=e?new r.FullBox:i?new r.ContainerBox:new r.Box,s&&(e?r.UUIDBoxes[t].prototype.parse=function(n){this.parseFullHeader(n),s&&s.call(this,n)}:r.UUIDBoxes[t].prototype.parse=s)}};r.initialize(),r.TKHD_FLAG_ENABLED=1,r.TKHD_FLAG_IN_MOVIE=2,r.TKHD_FLAG_IN_PREVIEW=4,r.TFHD_FLAG_BASE_DATA_OFFSET=1,r.TFHD_FLAG_SAMPLE_DESC=2,r.TFHD_FLAG_SAMPLE_DUR=8,r.TFHD_FLAG_SAMPLE_SIZE=16,r.TFHD_FLAG_SAMPLE_FLAGS=32,r.TFHD_FLAG_DUR_EMPTY=65536,r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,r.TRUN_FLAGS_DATA_OFFSET=1,r.TRUN_FLAGS_FIRST_FLAG=4,r.TRUN_FLAGS_DURATION=256,r.TRUN_FLAGS_SIZE=512,r.TRUN_FLAGS_FLAGS=1024,r.TRUN_FLAGS_CTS_OFFSET=2048,r.Box.prototype.add=function(t){return this.addBox(new r[t+"Box"])},r.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},r.Box.prototype.set=function(t,e){return this[t]=e,this},r.Box.prototype.addEntry=function(t,e){var i=e||"entries";return this[i]||(this[i]=[]),this[i].push(t),this},l.BoxParser=r,r.parseUUID=function(t){return r.parseHex16(t)},r.parseHex16=function(t){for(var e="",i=0;i<16;i++){var s=t.readUint8().toString(16);e+=s.length===1?"0"+s:s}return e},r.parseOneBox=function(t,e,i){var s,n=t.getPosition(),h=0,d,c;if(t.getEndPosition()-n<8)return o.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:r.ERR_NOT_ENOUGH_DATA};if(i&&i<8)return o.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:r.ERR_NOT_ENOUGH_DATA};var p=t.readUint32(),m=t.readString(4),y=m;if(o.debug("BoxParser","Found box of type '"+m+"' and size "+p+" at position "+n),h=8,m=="uuid"){if(t.getEndPosition()-t.getPosition()<16||i-h<16)return t.seek(n),o.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:r.ERR_NOT_ENOUGH_DATA};c=r.parseUUID(t),h+=16,y=c}if(p==1){if(t.getEndPosition()-t.getPosition()<8||i&&i-h<8)return t.seek(n),o.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+m+'" box'),{code:r.ERR_NOT_ENOUGH_DATA};p=t.readUint64(),h+=8}else if(p===0){if(i)p=i;else if(m!=="mdat")return o.error("BoxParser","Unlimited box size not supported for type: '"+m+"'"),s=new r.Box(m,p),{code:r.OK,box:s,size:s.size}}return p<h?(o.error("BoxParser","Box of type "+m+" has an invalid size "+p+" (too small to be a box)"),{code:r.ERR_NOT_ENOUGH_DATA,type:m,size:p,hdr_size:h,start:n}):i&&p>i?(o.error("BoxParser","Box of type '"+m+"' has a size "+p+" greater than its container size "+i),{code:r.ERR_NOT_ENOUGH_DATA,type:m,size:p,hdr_size:h,start:n}):n+p>t.getEndPosition()?(t.seek(n),o.info("BoxParser","Not enough data in stream to parse the entire '"+m+"' box"),{code:r.ERR_NOT_ENOUGH_DATA,type:m,size:p,hdr_size:h,start:n}):e?{code:r.OK,type:m,size:p,hdr_size:h,start:n}:(r[m+"Box"]?s=new r[m+"Box"](p):m!=="uuid"?(o.warn("BoxParser","Unknown box type: '"+m+"'"),s=new r.Box(m,p),s.has_unparsed_data=!0):r.UUIDBoxes[c]?s=new r.UUIDBoxes[c](p):(o.warn("BoxParser","Unknown uuid type: '"+c+"'"),s=new r.Box(m,p),s.uuid=c,s.has_unparsed_data=!0),s.hdr_size=h,s.start=n,s.write===r.Box.prototype.write&&s.type!=="mdat"&&(o.info("BoxParser","'"+y+"' box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),d=t.getPosition()-(s.start+s.size),d<0?(o.warn("BoxParser","Parsing of box '"+y+"' did not read the entire indicated box data size (missing "+-d+" bytes), seeking forward"),t.seek(s.start+s.size)):d>0&&(o.error("BoxParser","Parsing of box '"+y+"' read "+d+" more bytes than the indicated box data size, seeking backwards"),t.seek(s.start+s.size)),{code:r.OK,box:s,size:s.size})},r.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},r.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},r.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},r.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},r.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},r.ContainerBox.prototype.parse=function(t){for(var e,i;t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)if(i=e.box,this.boxes.push(i),this.subBoxNames&&this.subBoxNames.indexOf(i.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(i.type)]+"s"].push(i);else{var s=i.type!=="uuid"?i.type:i.uuid;this[s]?o.warn("Box of type "+s+" already stored in field of this type"):this[s]=i}else return},r.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},r.SAMPLE_ENTRY_TYPE_VISUAL="Visual",r.SAMPLE_ENTRY_TYPE_AUDIO="Audio",r.SAMPLE_ENTRY_TYPE_HINT="Hint",r.SAMPLE_ENTRY_TYPE_METADATA="Metadata",r.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",r.SAMPLE_ENTRY_TYPE_SYSTEM="System",r.SAMPLE_ENTRY_TYPE_TEXT="Text",r.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},r.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},r.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},r.SampleEntry.prototype.parseFooter=function(t){r.ContainerBox.prototype.parse.call(this,t)},r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_HINT),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SYSTEM),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_TEXT),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_TEXT,"enct"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"encm"),r.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,i=((e&1)+1)*16;this.layer_size=[];for(var s=0;s<3;s++)i==16?this.layer_size[s]=t.readUint16():this.layer_size[s]=t.readUint32()}),r.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),r.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),r.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){o.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){o.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){o.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){o.error("av1C reserved_2 parsing problem");return}var i=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(i)}),r.createBoxCtor("avcC",function(t){var e,i;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,i=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),i-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),i--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),i-=2+this.PPS[e].length;i>0&&(this.ext=t.readUint8Array(i))}),r.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),r.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),r.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),r.createFullBoxCtor("co64",function(t){var e,i;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(i=0;i<e;i++)this.chunk_offsets.push(t.readUint64())}),r.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),r.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),r.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),r.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),r.createFullBoxCtor("ctts",function(t){var e,i;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(i=0;i<e;i++){this.sample_counts.push(t.readUint32());var s=t.readInt32();s<0&&o.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(s)}else if(this.version==1)for(i=0;i<e;i++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),r.createBoxCtor("dac3",function(t){var e=t.readUint8(),i=t.readUint8(),s=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|i>>6&3,this.acmod=i>>3&7,this.lfeon=i>>2&1,this.bit_rate_code=i&3|s>>5&7}),r.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var i=0;i<this.num_ind_sub+1;i++){var s={};this.ind_subs.push(s);var n=t.readUint8(),h=t.readUint8(),d=t.readUint8();s.fscod=n>>6,s.bsid=n>>1&31,s.bsmod=(n&1)<<4|h>>4&15,s.acmod=h>>1&7,s.lfeon=h&1,s.num_dep_sub=d>>1&15,s.num_dep_sub>0&&(s.chan_loc=(d&1)<<8|t.readUint8())}}),r.createFullBoxCtor("dfLa",function(t){var e=127,i=128,s=[],n=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];this.parseFullHeader(t);do{var h=t.readUint8(),d=Math.min(h&e,n.length-1);if(d?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),s.push(n[d]),h&i)break}while(!0);this.numMetadataBlocks=s.length+" ("+s.join(", ")+")"}),r.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),r.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),r.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),r.createFullBoxCtor("dref",function(t){var e,i;this.entries=[];for(var s=t.readUint32(),n=0;n<s;n++)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)i=e.box,this.entries.push(i);else return}),r.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),r.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),r.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.entries.push(s),this.version===1?(s.segment_duration=t.readUint64(),s.media_time=t.readInt64()):(s.segment_duration=t.readUint32(),s.media_time=t.readInt32()),s.media_rate_integer=t.readInt16(),s.media_rate_fraction=t.readInt16()}}),r.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),r.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(typeof v<"u"){var i=new v;this.esd=i.parseOneDescriptor(new a(e.buffer,0,a.BIG_ENDIAN))}}),r.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),r.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),r.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var i=0;e>=4;)this.compatible_brands[i]=t.readString(4),e-=4,i++}),r.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),r.createBoxCtor("hvcC",function(t){var e,i,s,n;this.configurationVersion=t.readUint8(),n=t.readUint8(),this.general_profile_space=n>>6,this.general_tier_flag=(n&32)>>5,this.general_profile_idc=n&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),n=t.readUint8(),this.constantFrameRate=n>>6,this.numTemporalLayers=(n&13)>>3,this.temporalIdNested=(n&4)>>2,this.lengthSizeMinusOne=n&3,this.nalu_arrays=[];var h=t.readUint8();for(e=0;e<h;e++){var d=[];this.nalu_arrays.push(d),n=t.readUint8(),d.completeness=(n&128)>>7,d.nalu_type=n&63;var c=t.readUint16();for(i=0;i<c;i++){var p={};d.push(p),s=t.readUint16(),p.data=t.readUint8Array(s)}}}),r.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var i=0;i<this.entry_count;i++)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)e.box.type!=="infe"&&o.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[i]=e.box;else return}),r.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var i=0;if(this.version<2)i=t.readUint16();else if(this.version===2)i=t.readUint32();else throw"version of iloc box not supported";for(var s=0;s<i;s++){var n={};if(this.items.push(n),this.version<2)n.item_ID=t.readUint16();else if(this.version===2)n.item_ID=t.readUint16();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?n.construction_method=t.readUint16()&15:n.construction_method=0,n.data_reference_index=t.readUint16(),this.base_offset_size){case 0:n.base_offset=0;break;case 4:n.base_offset=t.readUint32();break;case 8:n.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var h=t.readUint16();n.extents=[];for(var d=0;d<h;d++){var c={};if(n.extents.push(c),this.version===1||this.version===2)switch(this.index_size){case 0:c.extent_index=0;break;case 4:c.extent_index=t.readUint32();break;case 8:c.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:c.extent_offset=0;break;case 4:c.extent_offset=t.readUint32();break;case 8:c.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:c.extent_length=0;break;case 4:c.extent_length=t.readUint32();break;case 8:c.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),r.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),r.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),o.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),r.createFullBoxCtor("ipma",function(t){var e,i;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var s={};this.associations.push(s),this.version<1?s.id=t.readUint16():s.id=t.readUint32();var n=t.readUint8();for(s.props=[],i=0;i<n;i++){var h=t.readUint8(),d={};s.props.push(d),d.essential=(h&128)>>7===1,this.flags&1?d.property_index=(h&127)<<8|t.readUint8():d.property_index=h&127}}}),r.createFullBoxCtor("iref",function(t){var e,i;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===r.OK)this.version===0?i=new r.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):i=new r.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),i.write===r.Box.prototype.write&&i.type!=="mdat"&&(o.warn("BoxParser",i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t),this.references.push(i);else return}),r.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),r.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),r.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),r.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var i=0;i<e;i++){var s={};this.levels[i]=s,s.track_ID=t.readUint32();var n=t.readUint8();switch(s.padding_flag=n>>7,s.assignment_type=n&127,s.assignment_type){case 0:s.grouping_type=t.readString(4);break;case 1:s.grouping_type=t.readString(4),s.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:s.sub_track_id=t.readUint32();break;default:o.warn("BoxParser","Unknown leva assignement type")}}}),r.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),r.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()}),r.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=t.readUint16(),this.display_primaries[0].y=t.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=t.readUint16(),this.display_primaries[1].y=t.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=t.readUint16(),this.display_primaries[2].y=t.readUint16(),this.white_point={},this.white_point.x=t.readUint16(),this.white_point.y=t.readUint16(),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),r.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),r.createFullBoxCtor("mehd",function(t){this.flags&1&&(o.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),r.createFullBoxCtor("meta",function(t){this.boxes=[],r.ContainerBox.prototype.parse.call(this,t)}),r.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),r.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),r.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),r.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),r.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),r.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var i=0;i<Math.floor((e+1)/2);i++)this.padbits=t.readUint8()}),r.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),r.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),r.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),r.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var i=0;i<e;i++)this.rate[i]=t.readUint32(),this.initial_delay[i]=t.readUint32()}),r.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),r.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),r.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),r.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),r.createFullBoxCtor("pssh",function(t){if(this.system_id=r.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var i=0;i<e;i++)this.kid[i]=r.parseHex16(t)}var s=t.readUint32();s>0&&(this.data=t.readUint8Array(s))}),r.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),r.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),r.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var i=0;i<e;i++)this.version===0?this.offset[i]=t.readUint32():this.offset[i]=t.readUint64()}),r.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var i=0;i<e;i++)this.sample_info_size[i]=t.readUint8()}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),r.createSampleGroupCtor("alst",function(t){var e,i=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<i;e++)this.sample_offset[e]=t.readUint32();var s=this.description_length-4-4*i;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<s/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),r.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),r.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var i=t.readUint8(),s=0;s<i;s++){var n={};this.dependency.push(n),n.subSeqDirectionFlag=t.readUint8(),n.layerNumber=t.readUint8(),n.subSequenceIdentifier=t.readUint16()}}),r.createSampleGroupCtor("dtrt",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("mvif",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),r.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),r.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)o.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),r.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),r.SampleGroupEntry.prototype.parse=function(t){o.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},r.createSampleGroupCtor("scif",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("scnm",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=r.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),r.createSampleGroupCtor("stsa",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),r.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),r.createSampleGroupCtor("tsas",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("tscl",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("vipr",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.entries.push(s),s.sample_count=t.readInt32(),s.group_description_index=t.readInt32()}}),r.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),r.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),r.createFullBoxCtor("sdtp",function(t){var e,i=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var s=0;s<i;s++)e=t.readUint8(),this.is_leading[s]=e>>6,this.sample_depends_on[s]=e>>4&3,this.sample_is_depended_on[s]=e>>2&3,this.sample_has_redundancy[s]=e&3}),r.createFullBoxCtor("senc"),r.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),o.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var s;r[this.grouping_type+"SampleGroupEntry"]?s=new r[this.grouping_type+"SampleGroupEntry"](this.grouping_type):s=new r.SampleGroupEntry(this.grouping_type),this.entries.push(s),this.version===1?this.default_length===0?s.description_length=t.readUint32():s.description_length=this.default_length:s.description_length=this.default_length,s.write===r.SampleGroupEntry.prototype.write&&(o.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),s.data=t.readUint8Array(s.description_length),t.position-=s.description_length),s.parse(t)}}),r.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),i=0;i<e;i++){var s={};this.references.push(s);var n=t.readUint32();s.reference_type=n>>31&1,s.referenced_size=n&2147483647,s.subsegment_duration=t.readUint32(),n=t.readUint32(),s.starts_with_SAP=n>>31&1,s.SAP_type=n>>28&7,s.SAP_delta_time=n&268435455}}),r.SingleItemTypeReferenceBox=function(t,e,i,s){r.Box.call(this,t,e),this.hdr_size=i,this.start=s},r.SingleItemTypeReferenceBox.prototype=new r.Box,r.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint16()},r.SingleItemTypeReferenceBoxLarge=function(t,e,i,s){r.Box.call(this,t,e),this.hdr_size=i,this.start=s},r.SingleItemTypeReferenceBoxLarge.prototype=new r.Box,r.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint32()},r.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),r.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),r.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.subsegments.push(s),s.ranges=[];for(var n=t.readUint32(),h=0;h<n;h++){var d={};s.ranges.push(d),d.level=t.readUint8(),d.range_size=t.readUint24()}}}),r.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var i=0;i<e;i++)this.chunk_offsets.push(t.readUint32())}),r.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var i=0;i<e;i++)this.priority[i]=t.readUint16()}),r.createFullBoxCtor("sthd"),r.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()}),r.createFullBoxCtor("stsc",function(t){var e,i;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(i=0;i<e;i++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),r.createFullBoxCtor("stsd",function(t){var e,i,s,n;for(this.entries=[],s=t.readUint32(),e=1;e<=s;e++)if(i=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),i.code===r.OK)r[i.type+"SampleEntry"]?(n=new r[i.type+"SampleEntry"](i.size),n.hdr_size=i.hdr_size,n.start=i.start):(o.warn("BoxParser","Unknown sample entry type: "+i.type),n=new r.SampleEntry(i.type,i.size,i.hdr_size,i.start)),n.write===r.SampleEntry.prototype.write&&(o.info("BoxParser","SampleEntry "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.entries.push(n);else return}),r.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var i=0;i<e;i++)this.group_description_index[i]=t.readUint32()}),r.createFullBoxCtor("stsh",function(t){var e,i;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(i=0;i<e;i++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),r.createFullBoxCtor("stss",function(t){var e,i;if(i=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<i;e++)this.sample_numbers.push(t.readUint32())}),r.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),r.createFullBoxCtor("stts",function(t){var e,i,s;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(i=0;i<e;i++)this.sample_counts.push(t.readUint32()),s=t.readInt32(),s<0&&(o.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)}),r.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var i=t.readUint32();this.stereo_indication_type=t.readString(i);var s,n;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(s=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),s.code===r.OK)n=s.box,this.boxes.push(n),this[n.type]=n;else return}),r.createBoxCtor("styp",function(t){r.ftypBox.prototype.parse.call(this,t)}),r.createFullBoxCtor("stz2",function(t){var e,i;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),i=t.readUint32(),this.field_size===4)for(e=0;e<i;e+=2){var s=t.readUint8();this.sample_sizes[e]=s>>4&15,this.sample_sizes[e+1]=s&15}else if(this.field_size===8)for(e=0;e<i;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<i;e++)this.sample_sizes[e]=t.readUint16();else o.error("BoxParser","Error in length field in stz2 box")}),r.createFullBoxCtor("subs",function(t){var e,i,s,n;for(s=t.readUint32(),this.entries=[],e=0;e<s;e++){var h={};if(this.entries[e]=h,h.sample_delta=t.readUint32(),h.subsamples=[],n=t.readUint16(),n>0)for(i=0;i<n;i++){var d={};h.subsamples.push(d),this.version==1?d.size=t.readUint32():d.size=t.readUint16(),d.priority=t.readUint8(),d.discardable=t.readUint8(),d.codec_specific_parameters=t.readUint32()}}}),r.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=r.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),r.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),r.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),r.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var i=t.readUint32(),s=0;s<i;s++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),r.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),r.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),r.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),r.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),r.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),r.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),r.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},r.createTrackGroupCtor("msrc"),r.TrackReferenceTypeBox=function(t,e,i,s){r.Box.call(this,t,e),this.hdr_size=i,this.start=s},r.TrackReferenceTypeBox.prototype=new r.Box,r.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},r.trefBox.prototype.parse=function(t){for(var e,i;t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===r.OK)i=new r.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),i.write===r.Box.prototype.write&&i.type!=="mdat"&&(o.info("BoxParser","TrackReference "+i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t),this.boxes.push(i);else return},r.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===r.OK)box=ret.box,this.boxes.push(box);else return}),r.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),r.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),r.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&r.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&r.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var i=0;i<this.sample_count;i++)this.flags&r.TRUN_FLAGS_DURATION&&(this.sample_duration[i]=t.readUint32()),this.flags&r.TRUN_FLAGS_SIZE&&(this.sample_size[i]=t.readUint32()),this.flags&r.TRUN_FLAGS_FLAGS&&(this.sample_flags[i]=t.readUint32()),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[i]=t.readUint32():this.sample_composition_time_offset[i]=t.readInt32())}),r.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()}),r.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),r.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),r.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),r.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),r.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=r.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),r.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),r.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=r.parseHex16(t)}),r.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var i={},s=0,n=0;this.version===1?(s=t.readUint64(),n=t.readUint64()):(s=t.readUint32(),n=t.readUint32()),i.absolute_time=s,i.absolute_duration=n,this.entries.push(i)}}),r.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),r.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),r.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),r.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),r.SampleEntry.prototype.isVideo=function(){return!1},r.SampleEntry.prototype.isAudio=function(){return!1},r.SampleEntry.prototype.isSubtitle=function(){return!1},r.SampleEntry.prototype.isMetadata=function(){return!1},r.SampleEntry.prototype.isHint=function(){return!1},r.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},r.SampleEntry.prototype.getWidth=function(){return""},r.SampleEntry.prototype.getHeight=function(){return""},r.SampleEntry.prototype.getChannelCount=function(){return""},r.SampleEntry.prototype.getSampleRate=function(){return""},r.SampleEntry.prototype.getSampleSize=function(){return""},r.VisualSampleEntry.prototype.isVideo=function(){return!0},r.VisualSampleEntry.prototype.getWidth=function(){return this.width},r.VisualSampleEntry.prototype.getHeight=function(){return this.height},r.AudioSampleEntry.prototype.isAudio=function(){return!0},r.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},r.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},r.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},r.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},r.MetadataSampleEntry.prototype.isMetadata=function(){return!0},r.decimalToHex=function(t,e){var i=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;i.length<e;)i="0"+i;return i},r.avc1SampleEntry.prototype.getCodec=r.avc2SampleEntry.prototype.getCodec=r.avc3SampleEntry.prototype.getCodec=r.avc4SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+r.decimalToHex(this.avcC.AVCProfileIndication)+r.decimalToHex(this.avcC.profile_compatibility)+r.decimalToHex(this.avcC.AVCLevelIndication):t},r.hev1SampleEntry.prototype.getCodec=r.hvc1SampleEntry.prototype.getCodec=function(){var t,e=r.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var i=this.hvcC.general_profile_compatibility,s=0;for(t=0;t<32&&(s|=i&1,t!=31);t++)s<<=1,i>>=1;e+=r.decimalToHex(s,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var n=!1,h="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||n)&&(h="."+r.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+h,n=!0);e+=h}return e},r.mp4aSampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),i=this.esds.esd.getAudioConfig();return t+"."+r.decimalToHex(e)+(i?"."+i:"")}else return t},r.stxtSampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},r.av01SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this),e;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?e=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(e=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+this.av1C.seq_level_idx_0+(this.av1C.seq_tier_0?"H":"M")+"."+e},r.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>_&&(this.size+=8),this.type==="uuid"&&(this.size+=16),o.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>_?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>_&&t.writeUint64(this.size)},r.FullBox.prototype.writeHeader=function(t){this.size+=4,r.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},r.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},r.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},r.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},r.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},r.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},r.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},r.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},r.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeUint32(i.segment_duration),t.writeInt32(i.media_time),t.writeInt16(i.media_rate_integer),t.writeInt16(i.media_rate_fraction)}},r.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},r.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},r.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},r.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},r.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},r.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},r.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},r.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},r.SampleEntry.prototype.writeHeader=function(t){this.size=8,r.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},r.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},r.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},r.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},r.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},r.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeInt32(i.sample_count),t.writeInt32(i.group_description_index)}},r.sgpdBox.prototype.write=function(t){var e,i;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)i=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=i.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)i=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(i.description_length),i.write(t)},r.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var i=this.references[e];t.writeUint32(i.reference_type<<31|i.referenced_size),t.writeUint32(i.subsegment_duration),t.writeUint32(i.starts_with_SAP<<31|i.SAP_type<<28|i.SAP_delta_time)}},r.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},r.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},r.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},r.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},r.stszBox.prototype.write=function(t){var e,i=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){i=!1;break}else e++;else i=!1;this.size=8,i||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),i?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),i||t.writeUint32Array(this.sample_sizes)},r.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},r.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},r.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&r.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&r.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&r.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&r.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&r.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},r.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},r.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},r.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&r.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&r.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&r.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&r.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&r.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&r.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&r.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&r.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&r.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&r.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},r["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},r["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},r.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},r.cttsBox.prototype.unpack=function(t){var e,i,s;for(s=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)t[s].pts=t[s].dts+this.sample_offsets[e],s++},r.sttsBox.prototype.unpack=function(t){var e,i,s;for(s=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)s===0?t[s].dts=0:t[s].dts=t[s-1].dts+this.sample_deltas[e],s++},r.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},r.stscBox.prototype.unpack=function(t){var e,i,s,n,h;for(n=0,h=0,e=0;e<this.first_chunk.length;e++)for(i=0;i<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);i++)for(h++,s=0;s<this.samples_per_chunk[e];s++){if(t[n])t[n].description_index=this.sample_description_index[e],t[n].chunk_index=h;else return;n++}},r.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},r.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],r.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],r.boxEqualFields=function(t,e){if(t&&!e)return!1;var i;for(i in t)if(!(r.DIFF_BOXES_PROP_NAMES.indexOf(i)>-1)){if(t[i]instanceof r.Box||e[i]instanceof r.Box)continue;if(typeof t[i]>"u"||typeof e[i]>"u")continue;if(typeof t[i]=="function"||typeof e[i]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(i.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(i.slice(0,4))>-1)continue;if(i==="data"||i==="start"||i==="size"||i==="creation_time"||i==="modification_time")continue;if(r.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(i)>-1)continue;if(t[i]!==e[i])return!1}return!0},r.boxEqual=function(t,e){if(!r.boxEqualFields(t,e))return!1;for(var i=0;i<r.DIFF_BOXES_PROP_NAMES.length;i++){var s=r.DIFF_BOXES_PROP_NAMES[i];if(t[s]&&e[s]&&!r.boxEqual(t[s],e[s]))return!1}return!0};var S=function(){};S.prototype.parseSample=function(t){var e={},i;e.resources=[];var s=new f(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=s.readString(t.data.length);else if(e.documentString=s.readString(t.subsamples[0].size),t.subsamples.length>1)for(i=1;i<t.subsamples.length;i++)e.resources[i]=s.readUint8Array(t.subsamples[i].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var w=function(){};w.prototype.parseSample=function(t){var e,i=new f(t.data.buffer);return e=i.readString(t.data.length),e},w.prototype.parseConfig=function(t){var e,i=new f(t.buffer);return i.readUint32(),e=i.readCString(),e},l.XMLSubtitlein4Parser=S,l.Textin4Parser=w;var u=function(t){this.stream=t||new g,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};u.prototype.setSegmentOptions=function(t,e,i){var s=this.getTrackById(t);if(s){var n={};this.fragmentedTracks.push(n),n.id=t,n.user=e,n.trak=s,s.nextSample=0,n.segmentStream=null,n.nb_samples=1e3,n.rapAlignement=!0,i&&(i.nbSamples&&(n.nb_samples=i.nbSamples),i.rapAlignement&&(n.rapAlignement=i.rapAlignement))}},u.prototype.unsetSegmentOptions=function(t){for(var e=-1,i=0;i<this.fragmentedTracks.length;i++){var s=this.fragmentedTracks[i];s.id==t&&(e=i)}e>-1&&this.fragmentedTracks.splice(e,1)},u.prototype.setExtractionOptions=function(t,e,i){var s=this.getTrackById(t);if(s){var n={};this.extractedTracks.push(n),n.id=t,n.user=e,n.trak=s,s.nextSample=0,n.nb_samples=1e3,n.samples=[],i&&i.nbSamples&&(n.nb_samples=i.nbSamples)}},u.prototype.unsetExtractionOptions=function(t){for(var e=-1,i=0;i<this.extractedTracks.length;i++){var s=this.extractedTracks[i];s.id==t&&(e=i)}e>-1&&this.extractedTracks.splice(e,1)},u.prototype.parse=function(){var t,e,i=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=r.parseOneBox(this.stream,i),t.code===r.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var s;switch(e=t.box,s=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),s){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[s]!==void 0&&o.warn("ISOFile","Duplicate Box of type: "+s+", overriding previous occurrence"),this[s]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},u.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(o.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(o.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(o.warn("ISOFile","Not ready to start parsing"),!1))},u.prototype.appendBuffer=function(t,e){var i;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(i=this.nextSeekPosition,this.nextSeekPosition=void 0):i=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(i=this.stream.getEndFilePositionAfter(i))):this.nextParsePosition?i=this.nextParsePosition:i=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(o.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+i),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),o.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),i},u.prototype.getInfo=function(){var t,e,i={},s,n,h,d=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(i.hasMoov=!0,i.duration=this.moov.mvhd.duration,i.timescale=this.moov.mvhd.timescale,i.isFragmented=this.moov.mvex!=null,i.isFragmented&&this.moov.mvex.mehd&&(i.fragment_duration=this.moov.mvex.mehd.fragment_duration),i.isProgressive=this.isProgressive,i.hasIOD=this.moov.iods!=null,i.brands=[],i.brands.push(this.ftyp.major_brand),i.brands=i.brands.concat(this.ftyp.compatible_brands),i.created=new Date(d+this.moov.mvhd.creation_time*1e3),i.modified=new Date(d+this.moov.mvhd.modification_time*1e3),i.tracks=[],i.audioTracks=[],i.videoTracks=[],i.subtitleTracks=[],i.metadataTracks=[],i.hintTracks=[],i.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(s=this.moov.traks[t],h=s.mdia.minf.stbl.stsd.entries[0],n={},i.tracks.push(n),n.id=s.tkhd.track_id,n.name=s.mdia.hdlr.name,n.references=[],s.tref)for(e=0;e<s.tref.boxes.length;e++)ref={},n.references.push(ref),ref.type=s.tref.boxes[e].type,ref.track_ids=s.tref.boxes[e].track_ids;s.edts&&(n.edits=s.edts.elst.entries),n.created=new Date(d+s.tkhd.creation_time*1e3),n.modified=new Date(d+s.tkhd.modification_time*1e3),n.movie_duration=s.tkhd.duration,n.movie_timescale=i.timescale,n.layer=s.tkhd.layer,n.alternate_group=s.tkhd.alternate_group,n.volume=s.tkhd.volume,n.matrix=s.tkhd.matrix,n.track_width=s.tkhd.width/65536,n.track_height=s.tkhd.height/65536,n.timescale=s.mdia.mdhd.timescale,n.cts_shift=s.mdia.minf.stbl.cslg,n.duration=s.mdia.mdhd.duration,n.samples_duration=s.samples_duration,n.codec=h.getCodec(),n.kind=s.udta&&s.udta.kinds.length?s.udta.kinds[0]:{schemeURI:"",value:""},n.language=s.mdia.elng?s.mdia.elng.extended_language:s.mdia.mdhd.languageString,n.nb_samples=s.samples.length,n.size=s.samples_size,n.bitrate=n.size*8*n.timescale/n.samples_duration,h.isAudio()?(n.type="audio",i.audioTracks.push(n),n.audio={},n.audio.sample_rate=h.getSampleRate(),n.audio.channel_count=h.getChannelCount(),n.audio.sample_size=h.getSampleSize()):h.isVideo()?(n.type="video",i.videoTracks.push(n),n.video={},n.video.width=h.getWidth(),n.video.height=h.getHeight()):h.isSubtitle()?(n.type="subtitles",i.subtitleTracks.push(n)):h.isHint()?(n.type="metadata",i.hintTracks.push(n)):h.isMetadata()?(n.type="metadata",i.metadataTracks.push(n)):(n.type="metadata",i.otherTracks.push(n))}else i.hasMoov=!1;if(i.mime="",i.hasMoov&&i.tracks){for(i.videoTracks&&i.videoTracks.length>0?i.mime+='video/mp4; codecs="':i.audioTracks&&i.audioTracks.length>0?i.mime+='audio/mp4; codecs="':i.mime+='application/mp4; codecs="',t=0;t<i.tracks.length;t++)t!==0&&(i.mime+=","),i.mime+=i.tracks[t].codec;i.mime+='"; profiles="',i.mime+=this.ftyp.compatible_brands.join(),i.mime+='"'}return i},u.prototype.processSamples=function(t){var e,i;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var s=this.fragmentedTracks[e];for(i=s.trak;i.nextSample<i.samples.length&&this.sampleProcessingStarted;){o.debug("ISOFile","Creating media fragment on track #"+s.id+" for sample "+i.nextSample);var n=this.createFragment(s.id,i.nextSample,s.segmentStream);if(n)s.segmentStream=n,i.nextSample++;else break;if((i.nextSample%s.nb_samples===0||t||i.nextSample>=i.samples.length)&&(o.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,i.nextSample-s.nb_samples)+","+(i.nextSample-1)+"]"),o.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,i.nextSample,t||i.nextSample>=i.samples.length),s.segmentStream=null,s!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var h=this.extractedTracks[e];for(i=h.trak;i.nextSample<i.samples.length&&this.sampleProcessingStarted;){o.debug("ISOFile","Exporting on track #"+h.id+" sample #"+i.nextSample);var d=this.getSample(i,i.nextSample);if(d)i.nextSample++,h.samples.push(d);else break;if((i.nextSample%h.nb_samples===0||i.nextSample>=i.samples.length)&&(o.debug("ISOFile","Sending samples on track #"+h.id+" for sample "+i.nextSample),this.onSamples&&this.onSamples(h.id,h.user,h.samples),h.samples=[],h!==this.extractedTracks[e]))break}}}},u.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},u.prototype.getBoxes=function(t,e){var i=[];return u._sweep.call(this,t,i,e),i},u._sweep=function(t,e,i){this.type&&this.type==t&&e.push(this);for(var s in this.boxes){if(e.length&&i)return;u._sweep.call(this.boxes[s],t,e,i)}},u.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},u.prototype.getTrackSample=function(t,e){var i=this.getTrackById(t),s=this.getSample(i,e);return s},u.prototype.releaseUsedSamples=function(t,e){var i=0,s=this.getTrackById(t);s.lastValidSample||(s.lastValidSample=0);for(var n=s.lastValidSample;n<e;n++)i+=this.releaseSample(s,n);o.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+i+", remaining: "+this.samplesDataSize+")"),s.lastValidSample=e},u.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},u.prototype.stop=function(){this.sampleProcessingStarted=!1},u.prototype.flush=function(){o.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},u.prototype.seekTrack=function(t,e,i){var s,n,h=1/0,d=0,c=0,p;if(i.samples.length===0)return o.info("ISOFile","No sample in track, cannot seek! Using time "+o.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(s=0;s<i.samples.length;s++){if(n=i.samples[s],s===0)c=0,p=n.timescale;else if(n.cts>t*n.timescale){c=s-1;break}e&&n.is_sync&&(d=s)}for(e&&(c=d),t=i.samples[c].cts,i.nextSample=c;i.samples[c].alreadyRead===i.samples[c].size&&i.samples[c+1];)c++;return h=i.samples[c].offset+i.samples[c].alreadyRead,o.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+i.nextSample+" on track "+i.tkhd.track_id+", time "+o.getDurationString(t,p)+" and offset: "+h),{offset:h,time:t/p}},u.prototype.seek=function(t,e){var i=this.moov,s,n,h,d={offset:1/0,time:1/0};if(this.moov){for(h=0;h<i.traks.length;h++)s=i.traks[h],n=this.seekTrack(t,e,s),n.offset<d.offset&&(d.offset=n.offset),n.time<d.time&&(d.time=n.time);return o.info("ISOFile","Seeking at time "+o.getDurationString(d.time,1)+" needs a buffer with a fileStart position of "+d.offset),d.offset===1/0?d={offset:this.nextParsePosition,time:0}:d.offset=this.stream.getEndFilePositionAfter(d.offset),o.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+d.offset),d}else throw"Cannot seek: moov not received!"},u.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var i=this.boxes[e],s=t.boxes[e];if(!r.boxEqual(i,s))return!1;e++}return!0},l.ISOFile=u,u.prototype.lastBoxStartPosition=0,u.prototype.parsingMdat=null,u.prototype.nextParsePosition=0,u.prototype.discardMdatData=!1,u.prototype.processIncompleteBox=function(t){var e,i,s;return t.type==="mdat"?(e=new r[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,s=this.stream.seek(e.start+e.size,!1,this.discardMdatData),s?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),i=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,i?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},u.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},u.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(o.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},u.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},u.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},u.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},u.prototype.add=r.Box.prototype.add,u.prototype.addBox=r.Box.prototype.addBox,u.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var i=this.add("moov");return i.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),i.add("mvex"),this},u.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var i=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,i.add("tkhd").set("flags",r.TKHD_FLAG_ENABLED|r.TKHD_FLAG_IN_MOVIE|r.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width).set("height",e.height);var s=i.add("mdia");s.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),s.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),s.add("elng").set("extended_language",e.language||"fr-FR");var n=s.add("minf");if(r[e.type+"SampleEntry"]!==void 0){var h=new r[e.type+"SampleEntry"];h.data_reference_index=1;var d="";for(var c in r.sampleEntryCodes)for(var p=r.sampleEntryCodes[c],m=0;m<p.length;m++)if(p.indexOf(e.type)>-1){d=c;break}switch(d){case"Visual":if(n.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),h.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var y=new r.avcCBox,x=new f(e.avcDecoderConfigRecord);y.parse(x),h.addBox(y)}break;case"Audio":n.add("smhd").set("balance",e.balance||0),h.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":n.add("hmhd");break;case"Subtitle":switch(n.add("sthd"),e.type){case"stpp":h.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":n.add("nmhd");break;case"System":n.add("nmhd");break;default:n.add("nmhd");break}e.description&&h.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(b){h.addBox(b)}),n.add("dinf").add("dref").addEntry(new r["url Box"]().set("flags",1));var A=n.add("stbl");return A.add("stsd").addEntry(h),A.add("stts").set("sample_counts",[]).set("sample_deltas",[]),A.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),A.add("stco").set("chunk_offsets",[]),A.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(i),e.id}},r.Box.prototype.computeSize=function(t){var e=t||new a;e.endianness=a.BIG_ENDIAN,this.write(e)},u.prototype.addSample=function(t,e,i){var s=i||{},n={},h=this.getTrackById(t);if(h!==null){n.number=h.samples.length,n.track_id=h.tkhd.track_id,n.timescale=h.mdia.mdhd.timescale,n.description_index=s.sample_description_index?s.sample_description_index-1:0,n.description=h.mdia.minf.stbl.stsd.entries[n.description_index],n.data=e,n.size=e.byteLength,n.alreadyRead=n.size,n.duration=s.duration||1,n.cts=s.cts||0,n.dts=s.dts||0,n.is_sync=s.is_sync||!1,n.is_leading=s.is_leading||0,n.depends_on=s.depends_on||0,n.is_depended_on=s.is_depended_on||0,n.has_redundancy=s.has_redundancy||0,n.degradation_priority=s.degradation_priority||0,n.offset=0,n.subsamples=s.subsamples,h.samples.push(n),h.samples_size+=n.size,h.samples_duration+=n.duration,h.first_dts||(h.first_dts=s.dts),this.processSamples();var d=this.createSingleSampleMoof(n);return this.addBox(d),d.computeSize(),d.trafs[0].truns[0].data_offset=d.size+8,this.add("mdat").data=new Uint8Array(e),n}},u.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var i=new r.moofBox;i.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var s=i.add("traf"),n=this.getTrackById(t.track_id);return s.add("tfhd").set("track_id",t.track_id).set("flags",r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),s.add("tfdt").set("baseMediaDecodeTime",t.dts-n.first_dts),s.add("trun").set("flags",r.TRUN_FLAGS_DATA_OFFSET|r.TRUN_FLAGS_DURATION|r.TRUN_FLAGS_SIZE|r.TRUN_FLAGS_FLAGS|r.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),i},u.prototype.lastMoofIndex=0,u.prototype.samplesDataSize=0,u.prototype.resetTables=function(){var t,e,i,s,n,h,d,c;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,i=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,i.chunk_offsets=[],s=e.mdia.minf.stbl.stsc,s.first_chunk=[],s.samples_per_chunk=[],s.sample_description_index=[],n=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,n.sample_sizes=[],h=e.mdia.minf.stbl.stts,h.sample_counts=[],h.sample_deltas=[],d=e.mdia.minf.stbl.ctts,d&&(d.sample_counts=[],d.sample_offsets=[]),c=e.mdia.minf.stbl.stss;var p=e.mdia.minf.stbl.boxes.indexOf(c);p!=-1&&(e.mdia.minf.stbl.boxes[p]=null)}},u.initSampleGroups=function(t,e,i,s,n){var h,d,c,p;function m(y,x,A){this.grouping_type=y,this.grouping_type_parameter=x,this.sbgp=A,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),d=0;d<i.length;d++){for(p=i[d].grouping_type+"/"+i[d].grouping_type_parameter,c=new m(i[d].grouping_type,i[d].grouping_type_parameter,i[d]),e&&(e.sample_groups_info[p]=c),t.sample_groups_info[p]||(t.sample_groups_info[p]=c),h=0;h<s.length;h++)s[h].grouping_type===i[d].grouping_type&&(c.description=s[h],c.description.used=!0);if(n)for(h=0;h<n.length;h++)n[h].grouping_type===i[d].grouping_type&&(c.fragment_description=n[h],c.fragment_description.used=!0,c.is_fragment=!0)}if(e){if(n)for(d=0;d<n.length;d++)!n[d].used&&n[d].version>=2&&(p=n[d].grouping_type+"/0",c=new m(n[d].grouping_type,0),c.is_fragment=!0,e.sample_groups_info[p]||(e.sample_groups_info[p]=c))}else for(d=0;d<s.length;d++)!s[d].used&&s[d].version>=2&&(p=s[d].grouping_type+"/0",c=new m(s[d].grouping_type,0),t.sample_groups_info[p]||(t.sample_groups_info[p]=c))},u.setSampleGroupProperties=function(t,e,i,s){var n,h;e.sample_groups=[];for(n in s)if(e.sample_groups[n]={},e.sample_groups[n].grouping_type=s[n].grouping_type,e.sample_groups[n].grouping_type_parameter=s[n].grouping_type_parameter,i>=s[n].last_sample_in_run&&(s[n].last_sample_in_run<0&&(s[n].last_sample_in_run=0),s[n].entry_index++,s[n].entry_index<=s[n].sbgp.entries.length-1&&(s[n].last_sample_in_run+=s[n].sbgp.entries[s[n].entry_index].sample_count)),s[n].entry_index<=s[n].sbgp.entries.length-1?e.sample_groups[n].group_description_index=s[n].sbgp.entries[s[n].entry_index].group_description_index:e.sample_groups[n].group_description_index=-1,e.sample_groups[n].group_description_index!==0){var d;s[n].fragment_description?d=s[n].fragment_description:d=s[n].description,e.sample_groups[n].group_description_index>0?(e.sample_groups[n].group_description_index>65535?h=(e.sample_groups[n].group_description_index>>16)-1:h=e.sample_groups[n].group_description_index-1,d&&h>=0&&(e.sample_groups[n].description=d.entries[h])):d&&d.version>=2&&d.default_group_description_index>0&&(e.sample_groups[n].description=d.entries[d.default_group_description_index-1])}},u.process_sdtp=function(t,e,i){e&&(t?(e.is_leading=t.is_leading[i],e.depends_on=t.sample_depends_on[i],e.is_depended_on=t.sample_is_depended_on[i],e.has_redundancy=t.sample_has_redundancy[i]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},u.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},u.prototype.buildTrakSampleLists=function(t){var e,i,s,n,h,d,c,p,m,y,x,A,b,P,L,j,H,G,D,N,X,$,V,K;if(t.samples=[],t.samples_duration=0,t.samples_size=0,i=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,s=t.mdia.minf.stbl.stsc,n=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,h=t.mdia.minf.stbl.stts,d=t.mdia.minf.stbl.ctts,c=t.mdia.minf.stbl.stss,p=t.mdia.minf.stbl.stsd,m=t.mdia.minf.stbl.subs,A=t.mdia.minf.stbl.stdp,y=t.mdia.minf.stbl.sbgps,x=t.mdia.minf.stbl.sgpds,G=-1,D=-1,N=-1,X=-1,$=0,V=0,K=0,u.initSampleGroups(t,null,y,x),!(typeof n>"u")){for(e=0;e<n.sample_sizes.length;e++){var T={};T.number=e,T.track_id=t.tkhd.track_id,T.timescale=t.mdia.mdhd.timescale,T.alreadyRead=0,t.samples[e]=T,T.size=n.sample_sizes[e],t.samples_size+=T.size,e===0?(P=1,b=0,T.chunk_index=P,T.chunk_run_index=b,H=s.samples_per_chunk[b],j=0,b+1<s.first_chunk.length?L=s.first_chunk[b+1]-1:L=1/0):e<H?(T.chunk_index=P,T.chunk_run_index=b):(P++,T.chunk_index=P,j=0,P<=L||(b++,b+1<s.first_chunk.length?L=s.first_chunk[b+1]-1:L=1/0),T.chunk_run_index=b,H+=s.samples_per_chunk[b]),T.description_index=s.sample_description_index[T.chunk_run_index]-1,T.description=p.entries[T.description_index],T.offset=i.chunk_offsets[T.chunk_index-1]+j,j+=T.size,e>G&&(D++,G<0&&(G=0),G+=h.sample_counts[D]),e>0?(t.samples[e-1].duration=h.sample_deltas[D],t.samples_duration+=t.samples[e-1].duration,T.dts=t.samples[e-1].dts+t.samples[e-1].duration):T.dts=0,d?(e>=N&&(X++,N<0&&(N=0),N+=d.sample_counts[X]),T.cts=t.samples[e].dts+d.sample_offsets[X]):T.cts=T.dts,c?(e==c.sample_numbers[$]-1?(T.is_sync=!0,$++):(T.is_sync=!1,T.degradation_priority=0),m&&m.entries[V].sample_delta+K==e+1&&(T.subsamples=m.entries[V].subsamples,K+=m.entries[V].sample_delta,V++)):T.is_sync=!0,u.process_sdtp(t.mdia.minf.stbl.sdtp,T,T.number),A?T.degradation_priority=A.priority[e]:T.degradation_priority=0,m&&m.entries[V].sample_delta+K==e&&(T.subsamples=m.entries[V].subsamples,K+=m.entries[V].sample_delta),(y.length>0||x.length>0)&&u.setSampleGroupProperties(t,T,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},u.prototype.updateSampleLists=function(){var t,e,i,s,n,h,d,c,p,m,y,x,A,b,P;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(p=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,p.type=="moof")for(m=p,t=0;t<m.trafs.length;t++){for(y=m.trafs[t],x=this.getTrackById(y.tfhd.track_id),A=this.getTrexById(y.tfhd.track_id),y.tfhd.flags&r.TFHD_FLAG_SAMPLE_DESC?s=y.tfhd.default_sample_description_index:s=A?A.default_sample_description_index:1,y.tfhd.flags&r.TFHD_FLAG_SAMPLE_DUR?n=y.tfhd.default_sample_duration:n=A?A.default_sample_duration:0,y.tfhd.flags&r.TFHD_FLAG_SAMPLE_SIZE?h=y.tfhd.default_sample_size:h=A?A.default_sample_size:0,y.tfhd.flags&r.TFHD_FLAG_SAMPLE_FLAGS?d=y.tfhd.default_sample_flags:d=A?A.default_sample_flags:0,y.sample_number=0,y.sbgps.length>0&&u.initSampleGroups(x,y,y.sbgps,x.mdia.minf.stbl.sgpds,y.sgpds),e=0;e<y.truns.length;e++){var L=y.truns[e];for(i=0;i<L.sample_count;i++){b={},b.moof_number=this.lastMoofIndex,b.number_in_traf=y.sample_number,y.sample_number++,b.number=x.samples.length,y.first_sample_index=x.samples.length,x.samples.push(b),b.track_id=x.tkhd.track_id,b.timescale=x.mdia.mdhd.timescale,b.description_index=s-1,b.description=x.mdia.minf.stbl.stsd.entries[b.description_index],b.size=h,L.flags&r.TRUN_FLAGS_SIZE&&(b.size=L.sample_size[i]),x.samples_size+=b.size,b.duration=n,L.flags&r.TRUN_FLAGS_DURATION&&(b.duration=L.sample_duration[i]),x.samples_duration+=b.duration,x.first_traf_merged||i>0?b.dts=x.samples[x.samples.length-2].dts+x.samples[x.samples.length-2].duration:(y.tfdt?b.dts=y.tfdt.baseMediaDecodeTime:b.dts=0,x.first_traf_merged=!0),b.cts=b.dts,L.flags&r.TRUN_FLAGS_CTS_OFFSET&&(b.cts=b.dts+L.sample_composition_time_offset[i]),P=d,L.flags&r.TRUN_FLAGS_FLAGS?P=L.sample_flags[i]:i===0&&L.flags&r.TRUN_FLAGS_FIRST_FLAG&&(P=L.first_sample_flags),b.is_sync=!(P>>16&1),b.is_leading=P>>26&3,b.depends_on=P>>24&3,b.is_depended_on=P>>22&3,b.has_redundancy=P>>20&3,b.degradation_priority=P&65535;var j=!!(y.tfhd.flags&r.TFHD_FLAG_BASE_DATA_OFFSET),H=!!(y.tfhd.flags&r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),G=!!(L.flags&r.TRUN_FLAGS_DATA_OFFSET),D=0;j?D=y.tfhd.base_data_offset:H||e===0?D=m.start:D=c,e===0&&i===0?G?b.offset=D+L.data_offset:b.offset=D:b.offset=c,c=b.offset+b.size,(y.sbgps.length>0||y.sgpds.length>0||x.mdia.minf.stbl.sbgps.length>0||x.mdia.minf.stbl.sgpds.length>0)&&u.setSampleGroupProperties(x,b,b.number_in_traf,y.sample_groups_info)}}if(y.subs){x.has_fragment_subsamples=!0;var N=y.first_sample_index;for(e=0;e<y.subs.entries.length;e++)N+=y.subs.entries[e].sample_delta,b=x.samples[N-1],b.subsamples=y.subs.entries[e].subsamples}}}},u.prototype.getSample=function(t,e){var i,s=t.samples[e];if(!this.moov)return null;if(!s.data)s.data=new Uint8Array(s.size),s.alreadyRead=0,this.samplesDataSize+=s.size,o.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+s.size+" (total: "+this.samplesDataSize+")");else if(s.alreadyRead==s.size)return s;for(;;){var n=this.stream.findPosition(!0,s.offset+s.alreadyRead,!1);if(n>-1){i=this.stream.buffers[n];var h=i.byteLength-(s.offset+s.alreadyRead-i.fileStart);if(s.size-s.alreadyRead<=h)return o.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-i.fileStart)+" read size: "+(s.size-s.alreadyRead)+" full size: "+s.size+")"),a.memcpy(s.data.buffer,s.alreadyRead,i,s.offset+s.alreadyRead-i.fileStart,s.size-s.alreadyRead),i.usedBytes+=s.size-s.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead=s.size,s;if(h===0)return null;o.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-i.fileStart)+" read size: "+h+" full size: "+s.size+")"),a.memcpy(s.data.buffer,s.alreadyRead,i,s.offset+s.alreadyRead-i.fileStart,h),s.alreadyRead+=h,i.usedBytes+=h,this.stream.logBufferLevel()}else return null}},u.prototype.releaseSample=function(t,e){var i=t.samples[e];return i.data?(this.samplesDataSize-=i.size,i.data=null,i.alreadyRead=0,i.size):0},u.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},u.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var i=this.moov.traks[t];t>0&&(e+=","),e+=i.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},u.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var i=this.moov.mvex.trexs[e];if(i.track_id==t)return i}return null},u.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var i=this.moov.traks[e];if(i.tkhd.track_id==t)return i}return null},u.prototype.items=[],u.prototype.itemsDataSize=0,u.prototype.flattenItemInfo=function(){var t=this.items,e,i,s,n=this.meta;if(n!=null&&n.hdlr!==void 0&&n.iinf!==void 0){for(e=0;e<n.iinf.item_infos.length;e++)s={},s.id=n.iinf.item_infos[e].item_ID,t[s.id]=s,s.ref_to=[],s.name=n.iinf.item_infos[e].item_name,n.iinf.item_infos[e].protection_index>0&&(s.protection=n.ipro.protections[n.iinf.item_infos[e].protection_index-1]),n.iinf.item_infos[e].item_type?s.type=n.iinf.item_infos[e].item_type:s.type="mime",s.content_type=n.iinf.item_infos[e].content_type,s.content_encoding=n.iinf.item_infos[e].content_encoding;if(n.iloc)for(e=0;e<n.iloc.items.length;e++){var h=n.iloc.items[e];switch(s=t[h.item_ID],h.data_reference_index!==0&&(o.warn("Item storage with reference to other files: not supported"),s.source=n.dinf.boxes[h.data_reference_index-1]),h.construction_method){case 0:break;case 1:o.warn("Item storage with construction_method : not supported");break;case 2:o.warn("Item storage with construction_method : not supported");break}for(s.extents=[],s.size=0,i=0;i<h.extents.length;i++)s.extents[i]={},s.extents[i].offset=h.extents[i].extent_offset+h.base_offset,s.extents[i].length=h.extents[i].extent_length,s.extents[i].alreadyRead=0,s.size+=s.extents[i].length}if(n.pitm&&(t[n.pitm.item_id].primary=!0),n.iref)for(e=0;e<n.iref.references.length;e++){var d=n.iref.references[e];for(i=0;i<d.references.length;i++)t[d.from_item_ID].ref_to.push({type:d.type,id:d.references[i]})}if(n.iprp)for(var c=0;c<n.iprp.ipmas.length;c++){var p=n.iprp.ipmas[c];for(e=0;e<p.associations.length;e++){var m=p.associations[e];for(s=t[m.id],s.properties===void 0&&(s.properties={},s.properties.boxes=[]),i=0;i<m.props.length;i++){var y=m.props[i];if(y.property_index>0&&y.property_index-1<n.iprp.ipco.boxes.length){var x=n.iprp.ipco.boxes[y.property_index-1];s.properties[x.type]=x,s.properties.boxes.push(x)}}}}}},u.prototype.getItem=function(t){var e,i;if(!this.meta)return null;if(i=this.items[t],!i.data&&i.size)i.data=new Uint8Array(i.size),i.alreadyRead=0,this.itemsDataSize+=i.size,o.debug("ISOFile","Allocating item #"+t+" of size "+i.size+" (total: "+this.itemsDataSize+")");else if(i.alreadyRead===i.size)return i;for(var s=0;s<i.extents.length;s++){var n=i.extents[s];if(n.alreadyRead!==n.length){var h=this.stream.findPosition(!0,n.offset+n.alreadyRead,!1);if(h>-1){e=this.stream.buffers[h];var d=e.byteLength-(n.offset+n.alreadyRead-e.fileStart);if(n.length-n.alreadyRead<=d)o.debug("ISOFile","Getting item #"+t+" extent #"+s+" data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-e.fileStart)+" read size: "+(n.length-n.alreadyRead)+" full extent size: "+n.length+" full item size: "+i.size+")"),a.memcpy(i.data.buffer,i.alreadyRead,e,n.offset+n.alreadyRead-e.fileStart,n.length-n.alreadyRead),e.usedBytes+=n.length-n.alreadyRead,this.stream.logBufferLevel(),i.alreadyRead+=n.length-n.alreadyRead,n.alreadyRead=n.length;else return o.debug("ISOFile","Getting item #"+t+" extent #"+s+" partial data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-e.fileStart)+" read size: "+d+" full extent size: "+n.length+" full item size: "+i.size+")"),a.memcpy(i.data.buffer,i.alreadyRead,e,n.offset+n.alreadyRead-e.fileStart,d),n.alreadyRead+=d,i.alreadyRead+=d,e.usedBytes+=d,this.stream.logBufferLevel(),null}else return null}}return i.alreadyRead===i.size?i:null},u.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var i=0;i<e.extents.length;i++){var s=e.extents[i];s.alreadyRead=0}return e.size}else return 0},u.prototype.processItems=function(t){for(var e in this.items){var i=this.items[e];this.getItem(i.id),t&&!i.sent&&(t(i),i.sent=!0,i.data=null)}},u.prototype.hasItem=function(t){for(var e in this.items){var i=this.items[e];if(i.name===t)return i.id}return-1},u.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},u.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},u.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},i=null;if(e.itemId?i=this.getItem(e.itemId):i=this.getPrimaryItem(),i==null)return null;var s=new u;s.discardMdatData=!1;var n={type:i.type,description_boxes:i.properties.boxes};i.properties.ispe&&(n.width=i.properties.ispe.image_width,n.height=i.properties.ispe.image_height);var h=s.addTrack(n);return h?(s.addSample(h,i.data),s):null},u.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},u.prototype.createFragment=function(t,e,i){var s=this.getTrackById(t),n=this.getSample(s,e);if(n==null)return n=s.samples[e],this.nextSeekPosition?this.nextSeekPosition=Math.min(n.offset+n.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=s.samples[e].offset+n.alreadyRead,null;var h=i||new a;h.endianness=a.BIG_ENDIAN;var d=this.createSingleSampleMoof(n);d.write(h),d.trafs[0].truns[0].data_offset=d.size+8,o.debug("MP4Box","Adjusting data_offset with new value "+d.trafs[0].truns[0].data_offset),h.adjustUint32(d.trafs[0].truns[0].data_offset_position,d.trafs[0].truns[0].data_offset);var c=new r.mdatBox;return c.data=n.data,c.write(h),h},u.writeInitializationSegment=function(t,e,i,s){var n;o.debug("ISOFile","Generating initialization segment");var h=new a;h.endianness=a.BIG_ENDIAN,t.write(h);var d=e.add("mvex");for(i&&d.add("mehd").set("fragment_duration",i),n=0;n<e.traks.length;n++)d.add("trex").set("track_id",e.traks[n].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",s).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(h),h.buffer},u.prototype.save=function(t){var e=new a;e.endianness=a.BIG_ENDIAN,this.write(e),e.save(t)},u.prototype.getBuffer=function(){var t=new a;return t.endianness=a.BIG_ENDIAN,this.write(t),t.buffer},u.prototype.initializeSegmentation=function(){var t,e,i,s;for(this.onSegment===null&&o.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var n=new r.moovBox;n.mvhd=this.moov.mvhd,n.boxes.push(n.mvhd),i=this.getTrackById(this.fragmentedTracks[t].id),n.boxes.push(i),n.traks.push(i),s={},s.id=i.tkhd.track_id,s.user=this.fragmentedTracks[t].user,s.buffer=u.writeInitializationSegment(this.ftyp,n,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(s)}return e},r.Box.prototype.printHeader=function(t){this.size+=8,this.size>_&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},r.FullBox.prototype.printHeader=function(t){this.size+=4,r.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},r.Box.prototype.print=function(t){this.printHeader(t)},r.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var i=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=i}},u.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},r.mvhdBox.prototype.print=function(t){r.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},r.tkhdBox.prototype.print=function(t){r.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var E={};E.createFile=function(t,e){var i=t!==void 0?t:!0,s=new u(e);return s.discardMdatData=!i,s},l.createFile=E.createFile}(Et)),Et}var ni=ri();class oi{constructor(o){this.data=new Uint8Array(o),this.idx=0,this.size=o}getData(){if(this.idx!==this.size)throw new Error("Mismatch between size reserved and sized used");return this.data.slice(0,this.idx)}writeUint8(o){this.data.set([o],this.idx),this.idx+=1}writeUint16(o){const f=new Uint16Array(1);f[0]=o;const a=new Uint8Array(f.buffer);this.data.set([a[1],a[0]],this.idx),this.idx+=2}writeUint8Array(o){this.data.set(o,this.idx),this.idx+=o.length}}const ai=l=>{let o,f=7;for(o=0;o<l.SPS.length;o+=1)f+=2+l.SPS[o].length;for(o=0;o<l.PPS.length;o+=1)f+=2+l.PPS[o].length;const a=new oi(f);for(a.writeUint8(l.configurationVersion),a.writeUint8(l.AVCProfileIndication),a.writeUint8(l.profile_compatibility),a.writeUint8(l.AVCLevelIndication),a.writeUint8(l.lengthSizeMinusOne+252),a.writeUint8(l.nb_SPS_nalus+224),o=0;o<l.SPS.length;o+=1)a.writeUint16(l.SPS[o].length),a.writeUint8Array(l.SPS[o].nalu);for(a.writeUint8(l.nb_PPS_nalus),o=0;o<l.PPS.length;o+=1)a.writeUint16(l.PPS[o].length),a.writeUint8Array(l.PPS[o].nalu);return a.getData()},hi=(l,o,{VideoDecoder:f,EncodedVideoChunk:a,debug:_})=>new Promise((g,v)=>{_&&console.info("Decoding video from",l);try{const r=ni.createFile();let S;const w=new f({output:u=>{createImageBitmap(u,{resizeQuality:"low"}).then(E=>{o(E),u.close(),w.decodeQueueSize<=0&&setTimeout(()=>{w.state!=="closed"&&(w.close(),g())},500)})},error:u=>{console.error(u),v(u)}});r.onReady=u=>{if(u&&u.videoTracks&&u.videoTracks[0]){[{codec:S}]=u.videoTracks,_&&console.info("Video with codec:",S);const E=r.moov.traks[0].mdia.minf.stbl.stsd.entries[0].avcC,t=ai(E);w.configure({codec:S,description:t}),r.setExtractionOptions(u.videoTracks[0].id),r.start()}else v(new Error("URL provided is not a valid mp4 video file."))},r.onSamples=(u,E,t)=>{for(let e=0;e<t.length;e+=1){const i=t[e],s=i.is_sync?"key":"delta",n=new a({type:s,timestamp:i.cts,duration:i.duration,data:i.data});w.decode(n)}},fetch(l).then(u=>{const E=u.body.getReader();let t=0;function e({done:i,value:s}){if(i)return r.flush(),null;const n=s.buffer;return n.fileStart=t,t+=n.byteLength,r.appendBuffer(n),E.read().then(e)}return E.read().then(e)})}catch(r){v(r)}}),li=(l,o,f)=>typeof VideoDecoder=="function"&&typeof EncodedVideoChunk=="function"?(f&&console.info("WebCodecs is natively supported, using native version..."),hi(l,o,{VideoDecoder,EncodedVideoChunk,debug:f})):(f&&console.info("WebCodecs is not available in this browser."),Promise.resolve());function di(l,o=0){let f;return function(...a){const _=this;clearTimeout(f),f=setTimeout(()=>{l.apply(_,a)},o)}}const Vt=(l,o=1)=>{const f=window.pageYOffset;return Math.abs(f-l)<o};class Yt{constructor({src:o,scrollyVideoContainer:f,cover:a=!0,sticky:_=!0,full:g=!0,trackScroll:v=!0,lockScroll:r=!0,transitionSpeed:S=8,frameThreshold:w=.1,useWebCodecs:u=!0,onReady:E=()=>{},onChange:t=()=>{},debug:e=!1}){if(typeof document!="object"){console.error("ScrollyVideo must be initiated in a DOM context");return}if(!f){console.error("scrollyVideoContainer must be a valid DOM object");return}if(!o){console.error("Must provide valid video src to ScrollyVideo");return}if(f instanceof Element)this.container=f;else if(typeof f=="string"){if(this.container=document.getElementById(f),!this.container)throw new Error("scrollyVideoContainer must be a valid DOM object")}else throw new Error("scrollyVideoContainer must be a valid DOM object");this.src=o,this.transitionSpeed=S,this.frameThreshold=w,this.useWebCodecs=u,this.cover=a,this.sticky=_,this.trackScroll=v,this.onReady=E,this.onChange=t,this.debug=e,this.video=document.createElement("video"),this.video.src=o,this.video.preload="auto",this.video.tabIndex=0,this.video.autobuffer=!0,this.video.playsInline=!0,this.video.muted=!0,this.video.pause(),this.video.load(),this.videoPercentage=0,this.container.appendChild(this.video),_&&(this.container.style.display="block",this.container.style.position="sticky",this.container.style.top="0"),g&&(this.container.style.width="100%",this.container.style.height="100vh",this.container.style.overflow="hidden"),a&&this.setCoverStyle(this.video);const i=new si().getEngine();this.isSafari=i.name==="WebKit",e&&this.isSafari&&console.info("Safari browser detected"),this.currentTime=0,this.targetTime=0,this.canvas=null,this.context=null,this.frames=[],this.frameRate=0;const s=di(()=>{window.requestAnimationFrame(()=>{this.setScrollPercent(this.videoPercentage)})},100);this.updateScrollPercentage=n=>{const h=this.container.parentNode.getBoundingClientRect(),d=-h.top/(h.height-window.innerHeight);this.debug&&console.info("ScrollyVideo scrolled to",d),this.targetScrollPosition==null?(this.setTargetTimePercent(d,{jump:n}),this.onChange(d)):Vt(this.targetScrollPosition)?this.targetScrollPosition=null:r&&this.targetScrollPosition!=null&&s()},this.trackScroll?(window.addEventListener("scroll",this.updateScrollPercentage),this.video.addEventListener("loadedmetadata",()=>this.updateScrollPercentage(!0),{once:!0})):this.video.addEventListener("loadedmetadata",()=>this.setTargetTimePercent(0,{jump:!0}),{once:!0}),this.resize=()=>{this.debug&&console.info("ScrollyVideo resizing..."),this.cover&&this.setCoverStyle(this.canvas||this.video),this.paintCanvasFrame(Math.floor(this.currentTime*this.frameRate))},window.addEventListener("resize",this.resize),this.video.addEventListener("progress",this.resize),this.decodeVideo()}setVideoPercentage(o,f={}){this.videoPercentage!==o&&(this.transitioningRaf&&window.cancelAnimationFrame(this.transitioningRaf),this.videoPercentage=o,this.onChange(o),this.trackScroll&&this.setScrollPercent(o),this.setTargetTimePercent(o,f))}setCoverStyle(o){if(this.cover){o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.minWidth="101%",o.style.minHeight="101%";const{width:f,height:a}=this.container.getBoundingClientRect(),_=o.videoWidth||o.width,g=o.videoHeight||o.height;this.debug&&console.info("Container dimensions:",[f,a]),this.debug&&console.info("Element dimensions:",[_,g]),f/a>_/g?(o.style.width="100%",o.style.height="auto"):(o.style.height="100%",o.style.width="auto")}}async decodeVideo(){if(!this.useWebCodecs){this.debug&&console.warn("Cannot perform video decode: `useWebCodes` disabled");return}if(!this.src){this.debug&&console.warn("Cannot perform video decode: no `src` found");return}try{await li(this.src,o=>{this.frames.push(o)},this.debug)}catch(o){this.debug&&console.error("Error encountered while decoding video",o),this.frames=[],this.video.load()}if(this.frames.length===0){this.debug&&console.error("No frames were received from webCodecs"),this.onReady();return}this.frameRate=this.frames.length/this.video.duration,this.debug&&console.info("Received",this.frames.length,"frames"),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.video.style.display="none",this.container.appendChild(this.canvas),this.cover&&this.setCoverStyle(this.canvas),this.paintCanvasFrame(Math.floor(this.currentTime*this.frameRate)),this.onReady()}paintCanvasFrame(o){const f=this.frames[o];if(!this.canvas||!f)return;this.debug&&console.info("Painting frame",o),this.canvas.width=f.width,this.canvas.height=f.height;const{width:a,height:_}=this.container.getBoundingClientRect();a/_>f.width/f.height?(this.canvas.style.width="100%",this.canvas.style.height="auto"):(this.canvas.style.height="100%",this.canvas.style.width="auto"),this.context.drawImage(f,0,0,f.width,f.height)}transitionToTargetTime({jump:o,transitionSpeed:f=this.transitionSpeed,easing:a=null}){this.debug&&console.info("Transitioning targetTime:",this.targetTime,"currentTime:",this.currentTime);const _=this.targetTime-this.currentTime,g=Math.abs(_),v=g*1e3,r=_>0,S=({startCurrentTime:w,startTimestamp:u,timestamp:E})=>{const t=(E-u)/v,e=r?this.currentTime>=this.targetTime:this.currentTime<=this.targetTime;if(isNaN(this.targetTime)||Math.abs(this.targetTime-this.currentTime)<this.frameThreshold||e){this.video.pause(),this.transitioningRaf&&(cancelAnimationFrame(this.transitioningRaf),this.transitioningRaf=null);return}this.targetTime>this.video.duration&&(this.targetTime=this.video.duration),this.targetTime<0&&(this.targetTime=0);const i=this.targetTime-this.currentTime,s=a&&Number.isFinite(t)?a(t):null,n=r?w+s*Math.abs(g)*f:w-s*Math.abs(g)*f;if(this.canvas)o?this.currentTime=this.targetTime:s?this.currentTime=n:this.currentTime+=i/(256/f),this.paintCanvasFrame(Math.floor(this.currentTime*this.frameRate));else if(o||this.isSafari||!r)this.video.pause(),s?this.currentTime=n:this.currentTime+=i/(64/f),o&&(this.currentTime=this.targetTime),this.video.currentTime=this.currentTime;else{const h=Math.max(Math.min(i*4,f,16),1);this.debug&&console.info("ScrollyVideo playbackRate:",h),isNaN(h)||(this.video.playbackRate=h,this.video.play()),this.currentTime=this.video.currentTime}typeof requestAnimationFrame=="function"&&(this.transitioningRaf=requestAnimationFrame(h=>S({startCurrentTime:w,startTimestamp:u,timestamp:h})))};typeof requestAnimationFrame=="function"&&(this.transitioningRaf=requestAnimationFrame(w=>{S({startCurrentTime:this.currentTime,startTimestamp:w,timestamp:w})}))}setTargetTimePercent(o,f={}){const a=this.frames.length&&this.frameRate?this.frames.length/this.frameRate:this.video.duration;this.targetTime=Math.max(Math.min(o,1),0)*a,!(!f.jump&&Math.abs(this.currentTime-this.targetTime)<this.frameThreshold)&&(!this.canvas&&!this.video.paused&&this.video.play(),this.transitionToTargetTime(f))}setScrollPercent(o){if(!this.trackScroll){console.warn("`setScrollPercent` requires enabled `trackScroll`");return}const f=this.container.parentNode,{top:a,height:_}=f.getBoundingClientRect(),g=a+window.pageYOffset,v=_-window.innerHeight,r=g+v*o;Vt(r)?this.targetScrollPosition=null:(window.scrollTo({top:r,behavior:"smooth"}),this.targetScrollPosition=r)}destroy(){this.debug&&console.info("Destroying ScrollyVideo"),this.trackScroll&&window.removeEventListener("scroll",this.updateScrollPercentage),window.removeEventListener("resize",this.resize),this.container&&(this.container.innerHTML="")}}var fi=lt('<div data-scrolly-container=""></div>');function ci(l,o){Jt(o,!1);let f=O(o,"src",8,void 0),a=O(o,"videoPercentage",8,void 0),_=O(o,"cover",8,!0),g=O(o,"sticky",8,!0),v=O(o,"full",8,!0),r=O(o,"trackScroll",8,!0),S=O(o,"lockScroll",8,!0),w=O(o,"transitionSpeed",8,8),u=O(o,"frameThreshold",8,.1),E=O(o,"useWebCodecs",8,!0),t=O(o,"onReady",8,()=>{}),e=O(o,"onChange",8,()=>{}),i=O(o,"debug",8,!1),s=_t(),n=_t(),h=_t({src:f(),cover:_(),sticky:g(),full:v(),trackScroll:r(),lockScroll:S(),transitionSpeed:w(),frameThreshold:u(),useWebCodecs:E(),debug:i()});const d=["src","useWebCodecs","trackScroll"],c=["transitionSpeed","frameThreshold","debug"];te(()=>{if(k(s))try{it(n,new Yt({src:f(),scrollyVideoContainer:k(s),cover:_(),sticky:g(),full:v(),trackScroll:r(),lockScroll:S(),transitionSpeed:w(),frameThreshold:u(),useWebCodecs:E(),onReady:t(),onChange:e(),debug:i()}))}catch(y){console.error("ScrollyVideo initialization failed:",y)}});function p(...y){k(n)&&k(n).setVideoPercentage(...y)}ee(()=>{var y;(y=k(n))!=null&&y.destroy&&(k(n).destroy(),it(n,null))}),Tt(()=>(k(n),k(s),M(f()),M(_()),M(g()),M(v()),M(r()),M(S()),M(w()),M(u()),M(E()),M(i()),k(h),M(t()),M(e())),()=>{if(k(n)&&k(s)){const y={src:f(),cover:_(),sticky:g(),full:v(),trackScroll:r(),lockScroll:S(),transitionSpeed:w(),frameThreshold:u(),useWebCodecs:E(),debug:i()},x=Object.keys(y).filter(A=>y[A]!==k(h)[A]);if(x.length>0){if(x.some(b=>d.includes(b))){k(n).destroy();try{it(n,new Yt({src:f(),scrollyVideoContainer:k(s),cover:_(),sticky:g(),full:v(),trackScroll:r(),lockScroll:S(),transitionSpeed:w(),frameThreshold:u(),useWebCodecs:E(),onReady:t(),onChange:e(),debug:i()}))}catch(b){console.error("ScrollyVideo recreation failed:",b)}}else x.forEach(b=>{c.includes(b)&&Pe(n,k(n)[b]=y[b])});it(h,{...y})}}}),Tt(()=>(k(n),M(a())),()=>{k(n)&&typeof a()=="number"&&a()>=0&&a()<=1&&k(n).setVideoPercentage(a())}),Qt(),jt();var m=fi();return De(m,y=>it(s,y),()=>k(s)),at(l,m),Qe(o,"setVideoPercentage",p),$t({setVideoPercentage:p})}var ui="1.3.11";function se(l,o,f){return Math.max(l,Math.min(o,f))}function pi(l,o,f){return(1-f)*l+f*o}function _i(l,o,f,a){return pi(l,o,1-Math.exp(-f*a))}function gi(l,o){return(l%o+o)%o}var mi=class{constructor(){U(this,"isRunning",!1);U(this,"value",0);U(this,"from",0);U(this,"to",0);U(this,"currentTime",0);U(this,"lerp");U(this,"duration");U(this,"easing");U(this,"onUpdate")}advance(l){var f;if(!this.isRunning)return;let o=!1;if(this.duration&&this.easing){this.currentTime+=l;const a=se(0,this.currentTime/this.duration,1);o=a>=1;const _=o?1:this.easing(a);this.value=this.from+(this.to-this.from)*_}else this.lerp?(this.value=_i(this.value,this.to,this.lerp*60,l),Math.round(this.value)===this.to&&(this.value=this.to,o=!0)):(this.value=this.to,o=!0);o&&this.stop(),(f=this.onUpdate)==null||f.call(this,this.value,o)}stop(){this.isRunning=!1}fromTo(l,o,{lerp:f,duration:a,easing:_,onStart:g,onUpdate:v}){this.from=this.value=l,this.to=o,this.lerp=f,this.duration=a,this.easing=_,this.currentTime=0,this.isRunning=!0,g==null||g(),this.onUpdate=v}};function yi(l,o){let f;return function(...a){let _=this;clearTimeout(f),f=setTimeout(()=>{f=void 0,l.apply(_,a)},o)}}var vi=class{constructor(l,o,{autoResize:f=!0,debounce:a=250}={}){U(this,"width",0);U(this,"height",0);U(this,"scrollHeight",0);U(this,"scrollWidth",0);U(this,"debouncedResize");U(this,"wrapperResizeObserver");U(this,"contentResizeObserver");U(this,"resize",()=>{this.onWrapperResize(),this.onContentResize()});U(this,"onWrapperResize",()=>{this.wrapper instanceof Window?(this.width=window.innerWidth,this.height=window.innerHeight):(this.width=this.wrapper.clientWidth,this.height=this.wrapper.clientHeight)});U(this,"onContentResize",()=>{this.wrapper instanceof Window?(this.scrollHeight=this.content.scrollHeight,this.scrollWidth=this.content.scrollWidth):(this.scrollHeight=this.wrapper.scrollHeight,this.scrollWidth=this.wrapper.scrollWidth)});this.wrapper=l,this.content=o,f&&(this.debouncedResize=yi(this.resize,a),this.wrapper instanceof Window?window.addEventListener("resize",this.debouncedResize,!1):(this.wrapperResizeObserver=new ResizeObserver(this.debouncedResize),this.wrapperResizeObserver.observe(this.wrapper)),this.contentResizeObserver=new ResizeObserver(this.debouncedResize),this.contentResizeObserver.observe(this.content)),this.resize()}destroy(){var l,o;(l=this.wrapperResizeObserver)==null||l.disconnect(),(o=this.contentResizeObserver)==null||o.disconnect(),this.wrapper===window&&this.debouncedResize&&window.removeEventListener("resize",this.debouncedResize,!1)}get limit(){return{x:this.scrollWidth-this.width,y:this.scrollHeight-this.height}}},re=class{constructor(){U(this,"events",{})}emit(l,...o){var a;let f=this.events[l]||[];for(let _=0,g=f.length;_<g;_++)(a=f[_])==null||a.call(f,...o)}on(l,o){var f;return(f=this.events[l])!=null&&f.push(o)||(this.events[l]=[o]),()=>{var a;this.events[l]=(a=this.events[l])==null?void 0:a.filter(_=>o!==_)}}off(l,o){var f;this.events[l]=(f=this.events[l])==null?void 0:f.filter(a=>o!==a)}destroy(){this.events={}}},Wt=100/6,Z={passive:!1},bi=class{constructor(l,o={wheelMultiplier:1,touchMultiplier:1}){U(this,"touchStart",{x:0,y:0});U(this,"lastDelta",{x:0,y:0});U(this,"window",{width:0,height:0});U(this,"emitter",new re);U(this,"onTouchStart",l=>{const{clientX:o,clientY:f}=l.targetTouches?l.targetTouches[0]:l;this.touchStart.x=o,this.touchStart.y=f,this.lastDelta={x:0,y:0},this.emitter.emit("scroll",{deltaX:0,deltaY:0,event:l})});U(this,"onTouchMove",l=>{const{clientX:o,clientY:f}=l.targetTouches?l.targetTouches[0]:l,a=-(o-this.touchStart.x)*this.options.touchMultiplier,_=-(f-this.touchStart.y)*this.options.touchMultiplier;this.touchStart.x=o,this.touchStart.y=f,this.lastDelta={x:a,y:_},this.emitter.emit("scroll",{deltaX:a,deltaY:_,event:l})});U(this,"onTouchEnd",l=>{this.emitter.emit("scroll",{deltaX:this.lastDelta.x,deltaY:this.lastDelta.y,event:l})});U(this,"onWheel",l=>{let{deltaX:o,deltaY:f,deltaMode:a}=l;const _=a===1?Wt:a===2?this.window.width:1,g=a===1?Wt:a===2?this.window.height:1;o*=_,f*=g,o*=this.options.wheelMultiplier,f*=this.options.wheelMultiplier,this.emitter.emit("scroll",{deltaX:o,deltaY:f,event:l})});U(this,"onWindowResize",()=>{this.window={width:window.innerWidth,height:window.innerHeight}});this.element=l,this.options=o,window.addEventListener("resize",this.onWindowResize,!1),this.onWindowResize(),this.element.addEventListener("wheel",this.onWheel,Z),this.element.addEventListener("touchstart",this.onTouchStart,Z),this.element.addEventListener("touchmove",this.onTouchMove,Z),this.element.addEventListener("touchend",this.onTouchEnd,Z)}on(l,o){return this.emitter.on(l,o)}destroy(){this.emitter.destroy(),window.removeEventListener("resize",this.onWindowResize,!1),this.element.removeEventListener("wheel",this.onWheel,Z),this.element.removeEventListener("touchstart",this.onTouchStart,Z),this.element.removeEventListener("touchmove",this.onTouchMove,Z),this.element.removeEventListener("touchend",this.onTouchEnd,Z)}},qt=l=>Math.min(1,1.001-Math.pow(2,-10*l)),wi=class{constructor({wrapper:l=window,content:o=document.documentElement,eventsTarget:f=l,smoothWheel:a=!0,syncTouch:_=!1,syncTouchLerp:g=.075,touchInertiaExponent:v=1.7,duration:r,easing:S,lerp:w=.1,infinite:u=!1,orientation:E="vertical",gestureOrientation:t=E==="horizontal"?"both":"vertical",touchMultiplier:e=1,wheelMultiplier:i=1,autoResize:s=!0,prevent:n,virtualScroll:h,overscroll:d=!0,autoRaf:c=!1,anchors:p=!1,autoToggle:m=!1,allowNestedScroll:y=!1,__experimental__naiveDimensions:x=!1}={}){U(this,"_isScrolling",!1);U(this,"_isStopped",!1);U(this,"_isLocked",!1);U(this,"_preventNextNativeScrollEvent",!1);U(this,"_resetVelocityTimeout",null);U(this,"__rafID",null);U(this,"isTouching");U(this,"time",0);U(this,"userData",{});U(this,"lastVelocity",0);U(this,"velocity",0);U(this,"direction",0);U(this,"options");U(this,"targetScroll");U(this,"animatedScroll");U(this,"animate",new mi);U(this,"emitter",new re);U(this,"dimensions");U(this,"virtualScroll");U(this,"onScrollEnd",l=>{l instanceof CustomEvent||(this.isScrolling==="smooth"||this.isScrolling===!1)&&l.stopPropagation()});U(this,"dispatchScrollendEvent",()=>{this.options.wrapper.dispatchEvent(new CustomEvent("scrollend",{bubbles:this.options.wrapper===window,detail:{lenisScrollEnd:!0}}))});U(this,"onTransitionEnd",l=>{if(l.propertyName.includes("overflow")){const o=this.isHorizontal?"overflow-x":"overflow-y",f=getComputedStyle(this.rootElement)[o];["hidden","clip"].includes(f)?this.internalStop():this.internalStart()}});U(this,"onClick",l=>{const f=l.composedPath().find(a=>{var _,g,v;return a instanceof HTMLAnchorElement&&(((_=a.getAttribute("href"))==null?void 0:_.startsWith("#"))||((g=a.getAttribute("href"))==null?void 0:g.startsWith("/#"))||((v=a.getAttribute("href"))==null?void 0:v.startsWith("./#")))});if(f){const a=f.getAttribute("href");if(a){const _=typeof this.options.anchors=="object"&&this.options.anchors?this.options.anchors:void 0;let g=`#${a.split("#")[1]}`;["#","/#","./#","#top","/#top","./#top"].includes(a)&&(g=0),this.scrollTo(g,_)}}});U(this,"onPointerDown",l=>{l.button===1&&this.reset()});U(this,"onVirtualScroll",l=>{if(typeof this.options.virtualScroll=="function"&&this.options.virtualScroll(l)===!1)return;const{deltaX:o,deltaY:f,event:a}=l;if(this.emitter.emit("virtual-scroll",{deltaX:o,deltaY:f,event:a}),a.ctrlKey||a.lenisStopPropagation)return;const _=a.type.includes("touch"),g=a.type.includes("wheel");this.isTouching=a.type==="touchstart"||a.type==="touchmove";const v=o===0&&f===0;if(this.options.syncTouch&&_&&a.type==="touchstart"&&v&&!this.isStopped&&!this.isLocked){this.reset();return}const S=this.options.gestureOrientation==="vertical"&&f===0||this.options.gestureOrientation==="horizontal"&&o===0;if(v||S)return;let w=a.composedPath();w=w.slice(0,w.indexOf(this.rootElement));const u=this.options.prevent;if(w.find(n=>{var h,d,c;return n instanceof HTMLElement&&(typeof u=="function"&&(u==null?void 0:u(n))||((h=n.hasAttribute)==null?void 0:h.call(n,"data-lenis-prevent"))||_&&((d=n.hasAttribute)==null?void 0:d.call(n,"data-lenis-prevent-touch"))||g&&((c=n.hasAttribute)==null?void 0:c.call(n,"data-lenis-prevent-wheel"))||this.options.allowNestedScroll&&this.checkNestedScroll(n,{deltaX:o,deltaY:f}))}))return;if(this.isStopped||this.isLocked){a.cancelable&&a.preventDefault();return}if(!(this.options.syncTouch&&_||this.options.smoothWheel&&g)){this.isScrolling="native",this.animate.stop(),a.lenisStopPropagation=!0;return}let t=f;this.options.gestureOrientation==="both"?t=Math.abs(f)>Math.abs(o)?f:o:this.options.gestureOrientation==="horizontal"&&(t=o),(!this.options.overscroll||this.options.infinite||this.options.wrapper!==window&&this.limit>0&&(this.animatedScroll>0&&this.animatedScroll<this.limit||this.animatedScroll===0&&f>0||this.animatedScroll===this.limit&&f<0))&&(a.lenisStopPropagation=!0),a.cancelable&&a.preventDefault();const e=_&&this.options.syncTouch,s=_&&a.type==="touchend";s&&(t=Math.sign(this.velocity)*Math.pow(Math.abs(this.velocity),this.options.touchInertiaExponent)),this.scrollTo(this.targetScroll+t,{programmatic:!1,...e?{lerp:s?this.options.syncTouchLerp:1}:{lerp:this.options.lerp,duration:this.options.duration,easing:this.options.easing}})});U(this,"onNativeScroll",()=>{if(this._resetVelocityTimeout!==null&&(clearTimeout(this._resetVelocityTimeout),this._resetVelocityTimeout=null),this._preventNextNativeScrollEvent){this._preventNextNativeScrollEvent=!1;return}if(this.isScrolling===!1||this.isScrolling==="native"){const l=this.animatedScroll;this.animatedScroll=this.targetScroll=this.actualScroll,this.lastVelocity=this.velocity,this.velocity=this.animatedScroll-l,this.direction=Math.sign(this.animatedScroll-l),this.isStopped||(this.isScrolling="native"),this.emit(),this.velocity!==0&&(this._resetVelocityTimeout=setTimeout(()=>{this.lastVelocity=this.velocity,this.velocity=0,this.isScrolling=!1,this.emit()},400))}});U(this,"raf",l=>{const o=l-(this.time||l);this.time=l,this.animate.advance(o*.001),this.options.autoRaf&&(this.__rafID=requestAnimationFrame(this.raf))});window.lenisVersion=ui,(!l||l===document.documentElement)&&(l=window),typeof r=="number"&&typeof S!="function"?S=qt:typeof S=="function"&&typeof r!="number"&&(r=1),this.options={wrapper:l,content:o,eventsTarget:f,smoothWheel:a,syncTouch:_,syncTouchLerp:g,touchInertiaExponent:v,duration:r,easing:S,lerp:w,infinite:u,gestureOrientation:t,orientation:E,touchMultiplier:e,wheelMultiplier:i,autoResize:s,prevent:n,virtualScroll:h,overscroll:d,autoRaf:c,anchors:p,autoToggle:m,allowNestedScroll:y,__experimental__naiveDimensions:x},this.dimensions=new vi(l,o,{autoResize:s}),this.updateClassName(),this.targetScroll=this.animatedScroll=this.actualScroll,this.options.wrapper.addEventListener("scroll",this.onNativeScroll,!1),this.options.wrapper.addEventListener("scrollend",this.onScrollEnd,{capture:!0}),this.options.anchors&&this.options.wrapper===window&&this.options.wrapper.addEventListener("click",this.onClick,!1),this.options.wrapper.addEventListener("pointerdown",this.onPointerDown,!1),this.virtualScroll=new bi(f,{touchMultiplier:e,wheelMultiplier:i}),this.virtualScroll.on("scroll",this.onVirtualScroll),this.options.autoToggle&&this.rootElement.addEventListener("transitionend",this.onTransitionEnd,{passive:!0}),this.options.autoRaf&&(this.__rafID=requestAnimationFrame(this.raf))}destroy(){this.emitter.destroy(),this.options.wrapper.removeEventListener("scroll",this.onNativeScroll,!1),this.options.wrapper.removeEventListener("scrollend",this.onScrollEnd,{capture:!0}),this.options.wrapper.removeEventListener("pointerdown",this.onPointerDown,!1),this.options.anchors&&this.options.wrapper===window&&this.options.wrapper.removeEventListener("click",this.onClick,!1),this.virtualScroll.destroy(),this.dimensions.destroy(),this.cleanUpClassName(),this.__rafID&&cancelAnimationFrame(this.__rafID)}on(l,o){return this.emitter.on(l,o)}off(l,o){return this.emitter.off(l,o)}setScroll(l){this.isHorizontal?this.options.wrapper.scrollTo({left:l,behavior:"instant"}):this.options.wrapper.scrollTo({top:l,behavior:"instant"})}resize(){this.dimensions.resize(),this.animatedScroll=this.targetScroll=this.actualScroll,this.emit()}emit(){this.emitter.emit("scroll",this)}reset(){this.isLocked=!1,this.isScrolling=!1,this.animatedScroll=this.targetScroll=this.actualScroll,this.lastVelocity=this.velocity=0,this.animate.stop()}start(){if(this.isStopped){if(this.options.autoToggle){this.rootElement.style.removeProperty("overflow");return}this.internalStart()}}internalStart(){this.isStopped&&(this.reset(),this.isStopped=!1,this.emit())}stop(){if(!this.isStopped){if(this.options.autoToggle){this.rootElement.style.setProperty("overflow","clip");return}this.internalStop()}}internalStop(){this.isStopped||(this.reset(),this.isStopped=!0,this.emit())}scrollTo(l,{offset:o=0,immediate:f=!1,lock:a=!1,duration:_=this.options.duration,easing:g=this.options.easing,lerp:v=this.options.lerp,onStart:r,onComplete:S,force:w=!1,programmatic:u=!0,userData:E}={}){if(!((this.isStopped||this.isLocked)&&!w)){if(typeof l=="string"&&["top","left","start"].includes(l))l=0;else if(typeof l=="string"&&["bottom","right","end"].includes(l))l=this.limit;else{let t;if(typeof l=="string"?t=document.querySelector(l):l instanceof HTMLElement&&(l!=null&&l.nodeType)&&(t=l),t){if(this.options.wrapper!==window){const i=this.rootElement.getBoundingClientRect();o-=this.isHorizontal?i.left:i.top}const e=t.getBoundingClientRect();l=(this.isHorizontal?e.left:e.top)+this.animatedScroll}}if(typeof l=="number"){if(l+=o,l=Math.round(l),this.options.infinite){if(u){this.targetScroll=this.animatedScroll=this.scroll;const t=l-this.animatedScroll;t>this.limit/2?l=l-this.limit:t<-this.limit/2&&(l=l+this.limit)}}else l=se(0,l,this.limit);if(l===this.targetScroll){r==null||r(this),S==null||S(this);return}if(this.userData=E??{},f){this.animatedScroll=this.targetScroll=l,this.setScroll(this.scroll),this.reset(),this.preventNextNativeScrollEvent(),this.emit(),S==null||S(this),this.userData={},requestAnimationFrame(()=>{this.dispatchScrollendEvent()});return}u||(this.targetScroll=l),typeof _=="number"&&typeof g!="function"?g=qt:typeof g=="function"&&typeof _!="number"&&(_=1),this.animate.fromTo(this.animatedScroll,l,{duration:_,easing:g,lerp:v,onStart:()=>{a&&(this.isLocked=!0),this.isScrolling="smooth",r==null||r(this)},onUpdate:(t,e)=>{this.isScrolling="smooth",this.lastVelocity=this.velocity,this.velocity=t-this.animatedScroll,this.direction=Math.sign(this.velocity),this.animatedScroll=t,this.setScroll(this.scroll),u&&(this.targetScroll=t),e||this.emit(),e&&(this.reset(),this.emit(),S==null||S(this),this.userData={},requestAnimationFrame(()=>{this.dispatchScrollendEvent()}),this.preventNextNativeScrollEvent())}})}}}preventNextNativeScrollEvent(){this._preventNextNativeScrollEvent=!0,requestAnimationFrame(()=>{this._preventNextNativeScrollEvent=!1})}checkNestedScroll(l,{deltaX:o,deltaY:f}){const a=Date.now(),_=l._lenis??(l._lenis={});let g,v,r,S,w,u,E,t;const e=this.options.gestureOrientation;if(a-(_.time??0)>2e3){_.time=Date.now();const m=window.getComputedStyle(l);_.computedStyle=m;const y=m.overflowX,x=m.overflowY;if(g=["auto","overlay","scroll"].includes(y),v=["auto","overlay","scroll"].includes(x),_.hasOverflowX=g,_.hasOverflowY=v,!g&&!v||e==="vertical"&&!v||e==="horizontal"&&!g)return!1;w=l.scrollWidth,u=l.scrollHeight,E=l.clientWidth,t=l.clientHeight,r=w>E,S=u>t,_.isScrollableX=r,_.isScrollableY=S,_.scrollWidth=w,_.scrollHeight=u,_.clientWidth=E,_.clientHeight=t}else r=_.isScrollableX,S=_.isScrollableY,g=_.hasOverflowX,v=_.hasOverflowY,w=_.scrollWidth,u=_.scrollHeight,E=_.clientWidth,t=_.clientHeight;if(!g&&!v||!r&&!S||e==="vertical"&&(!v||!S)||e==="horizontal"&&(!g||!r))return!1;let i;if(e==="horizontal")i="x";else if(e==="vertical")i="y";else{const m=o!==0,y=f!==0;m&&g&&r&&(i="x"),y&&v&&S&&(i="y")}if(!i)return!1;let s,n,h,d,c;if(i==="x")s=l.scrollLeft,n=w-E,h=o,d=g,c=r;else if(i==="y")s=l.scrollTop,n=u-t,h=f,d=v,c=S;else return!1;return(h>0?s<n:s>0)&&d&&c}get rootElement(){return this.options.wrapper===window?document.documentElement:this.options.wrapper}get limit(){return this.options.__experimental__naiveDimensions?this.isHorizontal?this.rootElement.scrollWidth-this.rootElement.clientWidth:this.rootElement.scrollHeight-this.rootElement.clientHeight:this.dimensions.limit[this.isHorizontal?"x":"y"]}get isHorizontal(){return this.options.orientation==="horizontal"}get actualScroll(){const l=this.options.wrapper;return this.isHorizontal?l.scrollX??l.scrollLeft:l.scrollY??l.scrollTop}get scroll(){return this.options.infinite?gi(this.animatedScroll,this.limit):this.animatedScroll}get progress(){return this.limit===0?1:this.scroll/this.limit}get isScrolling(){return this._isScrolling}set isScrolling(l){this._isScrolling!==l&&(this._isScrolling=l,this.updateClassName())}get isStopped(){return this._isStopped}set isStopped(l){this._isStopped!==l&&(this._isStopped=l,this.updateClassName())}get isLocked(){return this._isLocked}set isLocked(l){this._isLocked!==l&&(this._isLocked=l,this.updateClassName())}get isSmooth(){return this.isScrolling==="smooth"}get className(){let l="lenis";return this.options.autoToggle&&(l+=" lenis-autoToggle"),this.isStopped&&(l+=" lenis-stopped"),this.isLocked&&(l+=" lenis-locked"),this.isScrolling&&(l+=" lenis-scrolling"),this.isScrolling==="smooth"&&(l+=" lenis-smooth"),l}updateClassName(){this.cleanUpClassName(),this.rootElement.className=`${this.rootElement.className} ${this.className}`.trim()}cleanUpClassName(){this.rootElement.className=this.rootElement.className.replace(/lenis(-\w+)?/g,"").trim()}},Si=lt('<meta name="description" content="Responsive scrollable videos without obscure video encoding requirements" class="svelte-1gee6ec">'),xi=lt('<div class="cta-buttons svelte-1gee6ec"><a href="https://github.com/dkaoster/scrolly-video" class="button primary svelte-1gee6ec" target="_blank" rel="noopener"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" class="svelte-1gee6ec"><path d="M10 0C4.477 0 0 4.477 0 10c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0110 4.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C17.137 18.165 20 14.418 20 10c0-5.523-4.477-10-10-10z" class="svelte-1gee6ec"></path></svg> GitHub</a> <a href="https://www.npmjs.com/package/scrolly-video" class="button secondary svelte-1gee6ec" target="_blank" rel="noopener"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" class="svelte-1gee6ec"><path d="M0 0v20h20V0H0zm17 17H3V3h14v14z" class="svelte-1gee6ec"></path><path d="M5 5v10h5V7h2v8h3V5H5z" class="svelte-1gee6ec"></path></svg> npm</a></div>'),Ui=lt('<div class="step svelte-1gee6ec"><div class="step-content svelte-1gee6ec"><h2 class="step-title svelte-1gee6ec"> </h2> <p class="step-text svelte-1gee6ec"> </p> <!></div></div>'),Ei=lt('<section class="scrollytelling-container svelte-1gee6ec"><div class="video-scroll-container svelte-1gee6ec"><!></div> <div class="overlay svelte-1gee6ec"></div> <div class="foreground svelte-1gee6ec"></div></section>');function Pi(l,o){Jt(o,!1);const f=_t();let a;te(()=>{a=new wi({duration:1.2,easing:u=>Math.min(1,1.001-Math.pow(2,-10*u)),orientation:"vertical",smoothWheel:!0,wheelMultiplier:1,touchMultiplier:2});function w(u){a.raf(u),requestAnimationFrame(w)}requestAnimationFrame(w)}),ee(()=>{a&&a.destroy()});const _=[{title:"ScrollyVideo",text:"Works everywhere: React, Svelte, Vue, or plain HTML/JS."},{title:"WebCodecs API",text:"Works everywhere: React, Svelte, Vue, or plain HTML/JS"},{title:"Framework Agnostic",text:"Works everywhere: React, Svelte, Vue, or plain HTML/JS"},{title:"Easy Integration",text:"Simple API with minimal configuration needed to get started"},{title:"Optimized Performance",text:"Smart caching and frame management for smooth scrolling experience"},{title:"Mobile Friendly",text:"Fully responsive design that works beautifully on all devices"},{title:"Customizable",text:"Flexible options to control playback speed, transitions, and behavior"},{title:"Open Source",text:"Free to use with an active community and regular updates"}];Tt(()=>{},()=>{it(f,`${_.length*100+_.length*100}vh`)}),Qt(),jt();var g=Ei();Re(w=>{var u=Si();Le.title="ScrollyVideo - Responsive Scrollable Videos",at(w,u)});var v=et(g),r=et(v);ci(r,{src:`${Me??""}/output.mp4`,transitionSpeed:12,frameThreshold:.05,useWebCodecs:!0}),Q(v);var S=Ut(v,4);Ge(S,5,()=>_,Oe,(w,u,E)=>{var t=Ui();Ke(t,"data-step",E);var e=et(t),i=et(e),s=et(i,!0);Q(i);var n=Ut(i,2),h=et(n,!0);Q(n);var d=Ut(n,2);{var c=p=>{var m=xi();at(p,m)};Ne(d,p=>{k(u).cta&&p(c)})}Q(e),Q(t),Dt(()=>{Nt(s,k(u).title),Nt(h,k(u).text)}),at(w,t)}),Q(S),Q(g),Dt(()=>qe(g,`--scroll-height: ${k(f)??""}`)),at(l,g),$t()}export{Pi as component};
